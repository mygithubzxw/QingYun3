<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’äº‘ä¹‹å¿—3ç®—æé™å…³å¡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.2/decimal.min.js"></script>
    <!-- Vercel Analytics -->
    <!-- Vercel åŸç”Ÿåˆ†æï¼ˆéƒ¨ç½²åè‡ªåŠ¨å·¥ä½œï¼‰ -->
    <script defer src="/_vercel/insights/script.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            margin-bottom: 10px;
        }

        .description {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }

        .input-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-right: 1px solid #eee;
        }

        .output-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .result {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 4px solid #2575fc;
        }

        .result h3 {
            color: #2575fc;
            margin-bottom: 10px;
        }

        .output-log {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            margin-top: 20px;
        }

        .output-line {
            margin-bottom: 5px;
        }

        .highlight {
            color: #f39c12;
            font-weight: bold;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .magnitude-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .magnitude-table th {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: bold;
        }

        .magnitude-table td {
            padding: 10px 15px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .magnitude-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .magnitude-table tr:hover {
            background-color: #e9ecef;
        }

        .table-container {
            margin-top: 20px;
        }

        .table-title {
            font-size: 18px;
            color: #2575fc;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .format-examples {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* æŠ¤èº«ç¬¦å¡ç‰‡æ ·å¼ */
        .talisman-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .talisman-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .talisman-title {
            font-weight: bold;
            color: #2575fc;
            font-size: 18px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2575fc;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .talisman-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .talisman-form-group {
            margin-bottom: 10px;
        }

        .talisman-form-group label {
            font-size: 14px;
            margin-bottom: 3px;
            color: #666;
        }

        .talisman-form-group input,
        .talisman-form-group select {
            padding: 8px 10px;
            font-size: 14px;
        }

        /* è‡ªå®šä¹‰æŠ¤èº«ç¬¦æ ·å¼ */
        .custom-param-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .custom-param-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .custom-param-name {
            flex: 1;
            margin-right: 10px;
        }

        .remove-custom-param {
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .custom-param-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-param-inputs label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .custom-param-inputs input {
            width: auto;
            flex: 1;
        }

        #addCustomParam {
            background: #27ae60;
            margin-top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-icon {
            font-size: 18px;
            font-weight: bold;
        }

        /* è‡ªå®šä¹‰ç­–ç•¥æ ·å¼ */
        .strategy-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .strategy-controls {
            display: flex;
            gap: 10px;
        }

        .strategy-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .strategy-stage {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .stage-title {
            font-weight: bold;
            color: #2575fc;
            font-size: 16px;
        }

        .remove-stage {
            background: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .stage-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .stage-form-group {
            margin-bottom: 8px;
        }

        .stage-form-group label {
            font-size: 12px;
            margin-bottom: 3px;
            color: #666;
        }

        .stage-form-group input,
        .stage-form-group select {
            padding: 6px 8px;
            font-size: 14px;
        }

        .strategy-presets {
            margin-top: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* å®é™…å¼€å§‹å…³å¡è¾“å…¥æ¡†æ ·å¼ */
        .actual-level-input {
            width: 80px;
            margin-left: 10px;
        }

        /* æç¤ºä¿¡æ¯æ ·å¼ */
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: #fff;
            color: #2575fc;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            transition: all 0.3s;
            box-shadow: 0 0 0 1px #2575fc;
        }

        .tooltip-icon:hover {
            background-color: #2575fc;
            color: white;
        }

        .tooltip-text {
            visibility: hidden;
            width: 350px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* æ–°å¢çš„é˜¶æ®µè‡ªå®šä¹‰æŠ¤èº«ç¬¦æ ·å¼ */
        .stage-custom-param-group {
            background-color: #f8f9fa;
            padding: 10px 12px;
            /* å¢åŠ å†…è¾¹è·ï¼Œè®©å†…éƒ¨å…ƒç´ ä¸æ‹¥æŒ¤ */
            border-radius: 4px;
            margin-bottom: 8px;
            /* æ¯ä¸ªå®¹å™¨ä¹‹é—´ç•™é—´è· */
            border: 1px solid #e0e0e0;
            display: flex;
            /* ç”¨ flex å¸ƒå±€ç¡®ä¿å…ƒç´ æ¨ªå‘æ’åˆ— */
            align-items: center;
            /* å‚ç›´å±…ä¸­å†…éƒ¨å…ƒç´  */
            width: 100%;
            /* å æ»¡å¤–å±‚å®¹å™¨å®½åº¦ */
            box-sizing: border-box;
            /* ç¡®ä¿ padding ä¸å½±å“å®½åº¦ */
            gap: 12px;
            /* å¢åŠ å†…éƒ¨å…ƒç´ é—´è·ï¼Œé¿å…æŒ¤å‹ */
            flex-wrap: nowrap;
            /* PCç«¯å¼ºåˆ¶ä¸æ¢è¡Œï¼Œç¡®ä¿ä¸€è¡Œæ˜¾ç¤ºå®Œæ•´ */
        }


        .stage-custom-param-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
            /* è¾“å…¥æ¡†ä¹‹é—´ç•™è¶³é—´è· */
            flex: 1;
            /* å æ®å®¹å™¨å‰©ä½™æ‰€æœ‰ç©ºé—´ï¼Œç¡®ä¿èƒ½åŒ…è£¹è¾“å…¥æ¡† */
            flex-wrap: nowrap;
            /* å¼ºåˆ¶ä¸æ¢è¡Œ */
        }

        .stage-custom-param-inputs input {
            padding: 6px 8px;
            font-size: 14px;
            box-sizing: border-box;
            flex-shrink: 0;
            /* é˜²æ­¢è¾“å…¥æ¡†è¢«å‹ç¼© */
        }

        .stage-custom-param-inputs .stage-custom-param-name {
            width: 140px;
            /* åç§°è¾“å…¥æ¡†å›ºå®šå®½åº¦ï¼Œè¶³å¤Ÿæ˜¾ç¤ºâ€œè‡ªå®šä¹‰æŠ¤èº«ç¬¦Xâ€ */
            min-width: 140px;
            /* PCç«¯ä¸å…è®¸ç¼©å° */
        }

        .stage-custom-param-inputs .stage-custom-param-value {
            width: 100px;
            /* å€æ•°è¾“å…¥æ¡†å®½åº¦ */
            min-width: 100px;
        }

        .stage-custom-param-inputs .stage-custom-param-times {
            width: 80px;
            /* æ¬¡æ•°è¾“å…¥æ¡†å®½åº¦ */
            min-width: 80px;
        }

        .stage-custom-param-inputs label {
            margin-bottom: 0;
            white-space: nowrap;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* åˆ é™¤æŒ‰é’®æ ·å¼ - ç¡®ä¿åœ¨æœ€å³ä¾§ */
        .stage-remove-custom-param {
            background: #e74c3c;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
            margin-left: auto;
            /* å…³é”®ï¼šå°†æŒ‰é’®æ¨åˆ°æœ€å³ä¾§ */
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .custom-param-inputs {
                flex-direction: column;
                align-items: flex-start;
            }

            .custom-param-inputs input {
                width: 100%;
            }

            .stage-content {
                grid-template-columns: 1fr;
            }

            .actual-level-input {
                width: 100%;
                margin-left: 0;
                margin-top: 5px;
            }

            .stage-custom-param-inputs {
                flex-direction: column;
                align-items: flex-start;
            }

            .stage-custom-param-inputs input {
                width: 100%;
            }

            .talisman-content {
                grid-template-columns: 1fr;
            }

            .stage-custom-param-group {
                overflow-x: auto;
                /* å…è®¸æ°´å¹³æ»šåŠ¨ */
                padding: 8px;
            }

            .stage-custom-param-inputs {
                flex-wrap: nowrap;
                /* ç¦æ­¢æ¢è¡Œ */
            }

            .stage-custom-param-inputs input {
                min-width: 80px;
                /* ç§»åŠ¨ç«¯æœ€å°å®½åº¦ */
            }

            .stage-custom-param-group {
                gap: 15px;
                /* PCç«¯å¢åŠ é—´è·ï¼Œæ›´ç¾è§‚ */
            }

            .stage-custom-param-inputs {
                gap: 15px;
            }

            /* ç¡®ä¿åŸºç¡€ç•ªæ•°/åˆ†æ•°ä¸æŠ¤èº«ç¬¦å¡ç‰‡å¸ƒå±€åè°ƒ */
            .stage-form-group.basic-fan-group,
            .stage-form-group.basic-score-group {
                grid-column: span 1;
                /* PCç«¯è®©åŸºç¡€ç•ªæ•°/åˆ†æ•°å¹¶æ’æ˜¾ç¤º */
                max-width: none;
                /* å–æ¶ˆå®½åº¦é™åˆ¶ï¼Œé¿å…æŒ¤å‹ */
            }
        }

        .stage-custom-params-container {
            margin-top: 10px;
            width: 100%;
            /* ç¡®ä¿å®¹å™¨å æ»¡çˆ¶å…ƒç´ å®½åº¦ */
            box-sizing: border-box;
            /* é¿å… padding æ’‘å¤§å®¹å™¨ */
            padding: 4px 0;
            /* ä¸Šä¸‹ç•™å°‘é‡å†…è¾¹è·ï¼Œé¿å…å…ƒç´ è´´è¾¹ */
        }

        .add-stage-custom-param-btn {
            background: #27ae60;
            margin-top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 6px 10px;
            font-size: 12px;
            width: auto;
        }

        .stage-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        /* ç¡®ä¿åŸºç¡€ç•ªæ•°å’ŒåŸºç¡€åˆ†æ•°åœ¨æŠ¤èº«ç¬¦å¡ç‰‡ä¹‹åå•ç‹¬æˆè¡Œ */
        .stage-form-group[style*="grid-column"] {
            grid-column: 1 / -1;
        }

        /* ä¸ºæŠ¤èº«ç¬¦å¡ç‰‡è®¾ç½®ç‰¹å®šçš„ç½‘æ ¼åˆ—è·¨åº¦ */
        .talisman-card {
            grid-column: 1 / -1;
        }

        /* ç¡®ä¿åŸºç¡€ç•ªæ•°å’ŒåŸºç¡€åˆ†æ•°åœ¨æŠ¤èº«ç¬¦å¡ç‰‡ä¹‹åæ˜¾ç¤º */
        .stage-form-group:not(.talisman-card) {
            grid-column: span 1;
        }

        /* åœ¨PCç«¯ï¼Œè®©åŸºç¡€ç•ªæ•°å’ŒåŸºç¡€åˆ†æ•°å¹¶æ’æ˜¾ç¤º */
        @media (min-width: 769px) {

            .stage-form-group.basic-fan-group,
            .stage-form-group.basic-score-group {
                grid-column: span 1;
            }

            /* ç¡®ä¿åœ¨æŠ¤èº«ç¬¦å¡ç‰‡ä¹‹åçš„åŸºç¡€å‚æ•°æ­£ç¡®æ’åˆ— */
            .stage-content > .stage-form-group:not(.talisman-card) {
                max-width: 200px;
            }
        }

        /* çœ¼ç›å›¾æ ‡æ ·å¼ */
        .toggle-eye {
            cursor: pointer;
            margin-left: 10px;
            font-size: 18px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .toggle-eye.open {
            opacity: 1;
        }

        .toggle-eye.closed {
            opacity: 0.5;
        }

        /* è¡¨æ ¼éšè—æ—¶çš„æ ·å¼ */
        .magnitude-table.hidden {
            display: none;
        }

        /* æŠ¤èº«ç¬¦å†…å®¹éšè—æ ·å¼ */
        .talisman-content.hidden {
            display: none;
        }

        /* å…³å¡åˆ†æ•°å¯¹ç…§è¡¨å®¹å™¨æ ·å¼ */
        .score-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        /* è¡¨æ ¼éšè—æ ·å¼ */
        .score-table-container.hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>é’äº‘ä¹‹å¿—3ç®—æé™å…³å¡</h1>
        <p class="description">
            æ ¹æ®å½“å‰èµ„æºçŠ¶æ€è®¡ç®—å…³å¡æ¨è¿›æé™ï¼Œæ”¯æŒå¤šé˜¶æ®µè‡ªå®šä¹‰ç­–ç•¥
            <span class="tooltip-container">
						<span class="tooltip-icon">â“˜</span>
						<span class="tooltip-text">æ­¤è®¡ç®—å™¨ä½¿ç”¨é—¨æ§›ä¸ºçŸ¥é“è†¨èƒ€è½¬ä¼ å¯¼ç©æ³•ï¼æ”¯æŒå¤šé˜¶æ®µç­–ç•¥é…ç½®</span>
					</span>
        </p>
    </header>

    <div class="content">
        <div class="input-section">
            <h2>è¾“å…¥å‚æ•°
                <span class="tooltip-container">
							<span class="tooltip-icon">â“˜</span>
							<span class="tooltip-text">å•†åº—é˜¶æ®µ</span>
						</span>
            </h2>

            <div class="form-group">
                <label for="curLevel">å½“å‰å…³å¡EX</label>
                <input type="number" id="curLevel" value="1" min="1" max="163">
            </div>

            <!-- ç›—å°æŠ¤èº«ç¬¦å¡ç‰‡ -->
            <div class="talisman-card" id="dyTalismanCard">
                <div class="talisman-header">
                    <div class="talisman-title">æŠ¤èº«ç¬¦ - ç›—å°</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dyTalismanEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="talisman-content">
                    <div class="talisman-form-group">
                        <label for="dy">
                            ç›—å°ç•ªæ•°
                            <span class="tooltip-container">
										<span class="tooltip-icon">â“˜</span>
										<span class="tooltip-text">æ”¯æŒæ ¼å¼ï¼šæ•°å­—(396.87)ã€ç§‘å­¦è®¡æ•°æ³•(3.9687e34)ã€å•ä½(396.87æ²Ÿ)</span>
									</span>
                        </label>
                        <input type="text" id="dy" value="144.61">
                    </div>
                    <div class="talisman-form-group">
                        <label for="dy_type">ç›—å°ç±»å‹</label>
                        <select id="dy_type">
                            <option value="å¡ç»´è†¨èƒ€ç›—å°">å¡ç»´è†¨èƒ€ç›—å°</option>
                            <option value="å…¶ä»–å¡è†¨èƒ€ç›—å°">å…¶ä»–å¡è†¨èƒ€ç›—å°</option>
                            <option value="æ™®é€šç›—å°">æ™®é€šç›—å°</option>
                        </select>
                    </div>
                    <div class="talisman-form-group">
                        <label for="dy_times">ç›—å°æ¬¡æ•°</label>
                        <input type="number" id="dy_times" value="2" min="0">
                    </div>
                    <div class="talisman-form-group">
                        <label for="eat_fog">åƒè¿·é›¾æ¬¡æ•°</label>
                        <input type="number" id="eat_fog" value="0" min="0">
                    </div>
                </div>
            </div>

            <!-- è´Ÿé‡æŠ¤èº«ç¬¦å¡ç‰‡ -->
            <div class="talisman-card" id="fzTalismanCard">
                <div class="talisman-header">
                    <div class="talisman-title">æŠ¤èº«ç¬¦ - è´Ÿé‡</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="fzTalismanEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="talisman-content">
                    <div class="talisman-form-group">
                        <label for="fz">è´Ÿé‡ç•ªæ•°</label>
                        <input type="text" id="fz" value="378.36">
                    </div>
                    <div class="talisman-form-group">
                        <label for="fz_type">è´Ÿé‡ç±»å‹</label>
                        <select id="fz_type">
                            <option value="è†¨èƒ€è´Ÿé‡">è†¨èƒ€è´Ÿé‡</option>
                            <option value="å¤©ä½¿è´Ÿé‡">å¤©ä½¿è´Ÿé‡</option>
                            <option value="æ™®é€šè´Ÿé‡">æ™®é€šè´Ÿé‡</option>
                        </select>
                    </div>
                    <div class="talisman-form-group">
                        <label for="fz_times">è´Ÿé‡æ¬¡æ•°</label>
                        <input type="number" id="fz_times" value="2" min="0">
                    </div>
                    <div class="talisman-form-group">
                        <label for="lose_fz">äºè´Ÿé‡æ¬¡æ•°</label>
                        <input type="number" id="lose_fz" value="0" min="0">
                    </div>
                </div>
            </div>

            <!-- æœˆå…‰æŠ¤èº«ç¬¦å¡ç‰‡ -->
            <div class="talisman-card" id="ygTalismanCard">
                <div class="talisman-header">
                    <div class="talisman-title">æŠ¤èº«ç¬¦ - æœˆå…‰</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="ygTalismanEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="talisman-content">
                    <div class="talisman-form-group">
                        <label for="yg">æœˆå…‰ç•ªæ•°</label>
                        <input type="text" id="yg" value="56.02">
                    </div>
                    <div class="talisman-form-group">
                        <label for="yg_type">æœˆå…‰ç±»å‹</label>
                        <select id="yg_type">
                            <option value="æ™®é€šæœˆå…‰">æ™®é€šæœˆå…‰</option>
                            <option value="è†¨èƒ€æœˆå…‰">è†¨èƒ€æœˆå…‰</option>
                            <option value="å¤©ä½¿æœˆå…‰">å¤©ä½¿æœˆå…‰</option>
                        </select>
                    </div>
                    <div class="talisman-form-group">
                        <label for="yg_times">æœˆå…‰æ¬¡æ•°</label>
                        <input type="number" id="yg_times" value="1" min="0">
                    </div>
                    <div class="talisman-form-group">
                        <label for="lose_yg">äºæœˆå…‰æ¬¡æ•°</label>
                        <input type="number" id="lose_yg" value="0" min="0">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="basicFan">åŸºç¡€ç•ªæ•°</label>
                <input type="number" id="basicFan" value="19" min="1">
            </div>

            <div class="form-group">
                <label for="basicScore">åŸºç¡€åˆ†æ•°</label>
                <input type="number" id="basicScore" value="38" min="1">
            </div>

            <button id="addCustomParam">
                <span class="add-icon">+</span> æ·»åŠ è‡ªå®šä¹‰æŠ¤èº«ç¬¦
            </button>

            <div id="customParamsContainer">
                <!-- è‡ªå®šä¹‰æŠ¤èº«ç¬¦å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            </div>

            <button id="calculateBtn">è®¡ç®—å…³å¡æé™</button>

            <!-- è‡ªå®šä¹‰ç­–ç•¥éƒ¨åˆ† -->
            <div class="strategy-section">
                <div class="strategy-header">
                    <h2>è‡ªå®šä¹‰ç­–ç•¥
                        <span class="tooltip-container">
									<span class="tooltip-icon">â“˜</span>
									<span class="tooltip-text">1.æ”¯æŒä»ä»»æ„é˜¶æ®µå¼€å§‹è‡ªå®šä¹‰ç­–ç•¥<br/>
										2.ç¬¬ä¸€ä¸ªé˜¶æ®µé»˜è®¤åŒæ­¥ä¸Šé¢çš„å‚æ•°<br/>
										3.ä¸è€ƒè™‘æ ‡å‡†é…ç½®çš„æŠ¤èº«ç¬¦ä¹‹å¤–å…¶ä»–æŠ¤èº«ç¬¦çš„å½±å“<br/>
										4.æ¯ä¸ªé˜¶æ®µé»˜è®¤ä»¥æé™å…³å¡è½¬ä¸‹ä¸€é˜¶æ®µï¼Œéœ€è¦è‡ªå·±æ ¹æ®å®é™…æƒ…å†µå¡«ä¸‹ä¸€é˜¶æ®µçš„å®é™…å¼€å§‹å…³å¡<br/>
										5.å¦‚æœä»¥æ”¹ä¼ å¯¼å¡ç»´ä½œä¸ºå¼€å§‹é˜¶æ®µï¼Œä¸‹ä¸€ä¸ªæ”¹å²šæ˜Ÿé˜¶æ®µçš„å®é™…å¼€å§‹å…³å¡éœ€è¦è‡ªå·±å¡«ï¼Œå¦åˆ™è®¤ä¸ºæ²¡æ”¹å‡ºä¼ å¯¼å¡ç»´Gäº†
									</span>
								</span>
                    </h2>
                    <div class="strategy-controls">
                        <button class="strategy-btn" id="addStageBtn">+ æ·»åŠ é˜¶æ®µ</button>
                    </div>
                </div>

                <div id="strategyStagesContainer">
                    <!-- ç­–ç•¥é˜¶æ®µå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>

                <div class="strategy-presets">
                    <h3>é¢„è®¾ç­–ç•¥</h3>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="standard" id="twoInflationBtn">
                            è†¨èƒ€ç›—å°è†¨èƒ€è´Ÿé‡æ™®é€šæœˆå…‰
                        </button>
                        <button class="preset-btn" data-preset="singleDyHacker" id="singleDyHackerBtn">å•ç›—å°é»‘å®¢</button>
                    </div>
                </div>
            </div>

            <button id="calculateStrategyBtn"
                    style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);">æ‰§è¡Œç­–ç•¥è®¡ç®—
            </button>
        </div>

        <div class="output-section">
            <h2>è®¡ç®—ç»“æœ</h2>

            <!-- æ•°é‡çº§å¯¹ç…§è¡¨ -->
            <div class="table-container">
                <div class="table-title">
                    æ•°é‡çº§å¯¹ç…§è¡¨
                    <span class="toggle-eye open" id="toggleMagnitudeTable" title="ç‚¹å‡»éšè—è¡¨æ ¼">ğŸ‘ï¸</span>
                </div>
                <table class="magnitude-table" id="magnitudeTable">
                    <thead>
                    <tr>
                        <th>å•ä½</th>
                        <th>æ•°é‡çº§</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>ä¸‡</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>äº¿</td>
                        <td>8</td>
                    </tr>
                    <tr>
                        <td>å…†</td>
                        <td>12</td>
                    </tr>
                    <tr>
                        <td>äº¬</td>
                        <td>16</td>
                    </tr>
                    <tr>
                        <td>å“</td>
                        <td>20</td>
                    </tr>
                    <tr>
                        <td>ç§­</td>
                        <td>24</td>
                    </tr>
                    <tr>
                        <td>ç©°</td>
                        <td>28</td>
                    </tr>
                    <tr>
                        <td>æ²Ÿ</td>
                        <td>32</td>
                    </tr>
                    <tr>
                        <td>æ¶§</td>
                        <td>36</td>
                    </tr>
                    <tr>
                        <td>æ­£</td>
                        <td>40</td>
                    </tr>
                    <tr>
                        <td>è½½</td>
                        <td>44</td>
                    </tr>
                    <tr>
                        <td>æ</td>
                        <td>48</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- å…³å¡åˆ†æ•°å¯¹ç…§è¡¨ -->
            <div class="table-container">
                <div class="table-title">
                    å…³å¡åˆ†æ•°å¯¹ç…§è¡¨
                    <span class="toggle-eye closed" id="toggleScoreTable" title="ç‚¹å‡»æ˜¾ç¤ºè¡¨æ ¼">ğŸ™ˆ</span>
                </div>
                <div class="score-table-container hidden">
                    <table class="magnitude-table" id="scoreTable">
                        <thead>
                        <tr>
                            <th>å…³å¡</th>
                            <th>åˆ†æ•°</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="result">
                <h3>å½“å‰é…ç½®çš„æé™æ˜¯ï¼š<span id="resultText">ç­‰å¾…è®¡ç®—...</span></h3>
            </div>

            <div class="output-log" id="outputLog">
                <div class="output-line">ç­‰å¾…è®¡ç®—...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // å®šä¹‰å¸¸é‡
    const FZ_TYPE_PZ = "è†¨èƒ€è´Ÿé‡";
    const FZ_TYPE_TS = "å¤©ä½¿è´Ÿé‡";
    const FZ_TYPE_NORMAL = "æ™®é€šè´Ÿé‡";
    const YG_TYPE_PZ = "è†¨èƒ€æœˆå…‰";
    const YG_TYPE_TS = "å¤©ä½¿æœˆå…‰";
    const YG_TYPE_NORMAL = "æ™®é€šæœˆå…‰";
    const DY_TYPE_KW_PZ = "å¡ç»´è†¨èƒ€ç›—å°";
    const DY_TYPE_OTHER_PZ = "å…¶ä»–å¡è†¨èƒ€ç›—å°";
    const DY_TYPE_NORMAL = "æ™®é€šç›—å°";

    // æ•°é‡çº§å¯¹ç…§è¡¨
    const MAGNITUDE_MAP = {
        "ä¸‡": 4,
        "äº¿": 8,
        "å…†": 12,
        "äº¬": 16,
        "å“": 20,
        "ç§­": 24,
        "ç©°": 28,
        "æ²Ÿ": 32,
        "æ¶§": 36,
        "æ­£": 40,
        "è½½": 44,
        "æ": 48
    };

    // åˆå§‹åŒ–å…³å¡è¦æ±‚åˆ†æ•°
    const REQUIRED_SCORE = initRequiredScore();

    // è‡ªå®šä¹‰æŠ¤èº«ç¬¦è®¡æ•°å™¨
    let customParamCounter = 1;
    // é˜¶æ®µè®¡æ•°å™¨
    let stageCounter = 1;
    // æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªé˜¶æ®µ
    let hasNextStage = true;

    // åˆå§‹åŒ–å…³å¡è¦æ±‚åˆ†æ•°
    function initRequiredScore() {
        const ORIGINAL_REQUIRED_SCORE =
            "1.00E+06,1.20E+07,9.08E+07,8.11E+08,8.43E+09,1.00E+11,1.35E+12,2.06E+13,3.48E+14,6.54E+15,1.36E+17,3.09E+18,7.68E+19,2.08E+21,6.64E+22,2.46E+24,1.05E+26,5.15E+27,2.82E+29,1.83E+31,1.31E+33,1.07E+35,9.72E+36,9.94E+38,1.14E+41,1.46E+43,2.08E+45,3.31E+47,5.85E+49,1.26E+52,3.00E+54,8.71E+56,2.79E+59,1.08E+62,4.63E+64,2.40E+67,1.37E+70,9.41E+72,7.15E+75,7.09E+78,9.17E+81,1.55E+85,3.40E+88,9.73E+91,3.63E+95,1.11E+99,1.11E+103,9.11E+106,9.72E+110,1.35E+115,2.81E+119,8.79E+123,4.12E+128,2.90E+134,3.06E+138,4.84E+143,1.15E+149,4.10E+154,2.19E+160,1.76E+166,2.11E+172,3.80E+178,1.03E+185,4.17E+191,2.54E+198,2.32E+205,3.18E+212,6.54E+219,2.02E+227,9.31E+234,6.46E+242,6.72E+250,1.05E+259,2.45E+267,8.60E+275,4.53E+284,3.58E+293,4.24E+302,5.7E310,5.7E318,5.7E326,5.7E334,5.7E342,5.7E350,5.7E359,5.7E368,5.7E377,5.7E386,5.7E395,5.7E405,5.7E415,5.7E425,5.7E435,5.7E445,5.7E455,5.7E466,5.7E477,5.7E488,5.7E499,9.999E510,9.999E522,9.999E534,9.999E546,9.999E558,9.999E571,9.999E584,9.999E597,9.999E611,9.999E625,9.999E639,9.999E654,9.999E669,9.999E684,9.999E699,9.999E715,9.999E731,9.999E748,9.999E765,9.999E783,9.999E801,9.999E820,9.999E839,9.999E859,9.999E879,9.999E900,9.999E921,9.999E943,9.999E966,9.999E990,9.999E1015,9.999E1041,9.999E1068,9.999E1096,2.9997E1126,9.999E1155,9.999E1186,9.999E1218,9.999E1251,9.999E1285,9.999E1320,9.999E1356,9.999E1393,9.999E1431,9.999E1470,9.999E1510,9.999E1551,9.999E1593,9.999E1636,9.999E1680,2.9997E1726,9.999E1771,9.999E1818,2.9997E1867,9.999E1915,9.999E1965,9.999E2016,9.999E2068,2.9997E2122,9.999E2175,9.999E2230,9.999E2286,9.999E2343,9.999E2401,9.999E2460";
        const REQUIRED_SCORE = new Array(164);
        const split = ORIGINAL_REQUIRED_SCORE.split(",");
        for (let i = 0; i < split.length; i++) {
            REQUIRED_SCORE[i] = new Decimal(split[i]);
        }
        return REQUIRED_SCORE;
    }


    // ç§‘å­¦è®¡æ•°æ³•æ ¼å¼åŒ–
    function formatScientific(number) {
        if (number.isZero()) return "0.00";
        return number.toExponential(2);
    }

    // è§£ææ•°å€¼è¾“å…¥ï¼Œæ”¯æŒæ•°å­—ã€ç§‘å­¦è®¡æ•°æ³•å’Œå•ä½
    function parseValue(input) {
        if (input.includes('e') || input.includes('E')) {
            return new Decimal(input);
        }

        let unit = null;
        let numericPart = input;

        for (const unitChar in MAGNITUDE_MAP) {
            if (input.includes(unitChar)) {
                unit = unitChar;
                numericPart = input.replace(unitChar, '');
                break;
            }
        }

        const value = new Decimal(numericPart);

        if (unit) {
            const magnitude = MAGNITUDE_MAP[unit];
            return value.times(Decimal.pow(10, magnitude));
        }

        return value;
    }

    // è·å–æ•°å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™è¿”å›0
    function getValueOrDefault(value, defaultValue = 0) {
        return value === '' ? defaultValue : value;
    }

    // è·å–æŠ¤èº«ç¬¦å¯ç”¨çŠ¶æ€
    function getTalismanEnabledStates() {
        return {
            dy: document.getElementById('dyTalismanEnabled').checked,
            fz: document.getElementById('fzTalismanEnabled').checked,
            yg: document.getElementById('ygTalismanEnabled').checked
        };
    }

    // æ‰§è¡Œå½“å‰å…³å¡è®¡ç®—
    function executeCurrentStage(curLevel, actualLevel, nextStageActualLevel, dy, fz, yg, lose_fz, lose_yg, eat_fog,
                                 dy_type, fz_type, yg_type, basicFan, basicScore, dy_times, fz_times, yg_times, customizedParams, stageName = "",
                                 talismanEnabled = {
                                     dy: true,
                                     fz: true,
                                     yg: true
                                 }
    ) {
        let toNextStage = false;
        let outputLines = [];
        let isFirstLoop = true;
        let startLevel = curLevel;

        let dy_first = talismanEnabled.dy_first;
        let fz_first = talismanEnabled.fz_first;
        let yg_first = talismanEnabled.yg_first;

        // å¦‚æœä¸Šä¸€ä¸ªé˜¶æ®µç»“æŸäº†ï¼Œæ²¡æœ‰ä¸‹ä¸€ä¸ªé˜¶æ®µï¼Œç›´æ¥è¿”å›
        if (!hasNextStage) {
            return {
                nextLevel: curLevel,
                dy: dy,
                fz: fz,
                yg: yg,
                outputLines: outputLines
            };
        }

        // å¦‚æœæœ‰å®é™…å¼€å§‹å…³å¡ï¼Œç›´æ¥ä½¿ç”¨å¡«å†™çš„å€¼
        if (actualLevel !== 0) {
            curLevel = actualLevel;
            startLevel = actualLevel;
            outputLines.push(`<span class="highlight">ä½¿ç”¨å®é™…å¼€å§‹å…³å¡: EX${actualLevel}</span>`);
        }

        if (stageName) {
            outputLines.push(`<span class="highlight">=== é˜¶æ®µ: ${stageName} ===</span>`);
        }

        // è¾“å‡ºæŠ¤èº«ç¬¦å¯ç”¨çŠ¶æ€
        if (talismanEnabled.dy) {
            outputLines.push(`<span class="highlight">ç›—å°æŠ¤èº«ç¬¦å·²å¯ç”¨</span>`);
        }
        if (talismanEnabled.fz) {
            outputLines.push(`<span class="highlight">è´Ÿé‡æŠ¤èº«ç¬¦å·²å¯ç”¨</span>`);
        }
        if (talismanEnabled.yg) {
            outputLines.push(`<span class="highlight">æœˆå…‰æŠ¤èº«ç¬¦å·²å¯ç”¨</span>`);
        }

        while (!toNextStage) {
            if (talismanEnabled.dy) {
                outputLines.push(`EX${curLevel}ç›—å°ï¼š${formatScientific(dy)}`);
            }

            // è€ƒè™‘äºè´Ÿé‡ - åªåœ¨è´Ÿé‡æŠ¤èº«ç¬¦å¯ç”¨æ—¶å¤„ç†
            if (talismanEnabled.fz) {
                if (lose_fz <= 0) {
                    // è´Ÿé‡ç±»å‹
                    switch (fz_type) {
                        case FZ_TYPE_NORMAL:
                            fz = fz.times(1.5);
                            break;
                        case FZ_TYPE_TS:
                            fz = fz.times(2);
                            break;
                        case FZ_TYPE_PZ:
                            fz = fz.times(1.5 * 1.5);
                            break;
                    }
                } else {
                    lose_fz--;
                }
                outputLines.push(`EX${curLevel}è´Ÿé‡ï¼š${formatScientific(fz)}`);
            }

            // è€ƒè™‘äºæœˆå…‰ - åªåœ¨æœˆå…‰æŠ¤èº«ç¬¦å¯ç”¨æ—¶å¤„ç†
            if (talismanEnabled.yg) {
                if (lose_yg <= 0) {
                    // æœˆå…‰ç±»å‹
                    switch (yg_type) {
                        case YG_TYPE_NORMAL:
                            yg = yg.times(1.5);
                            break;
                        case YG_TYPE_TS:
                            yg = yg.times(2);
                            break;
                        case YG_TYPE_PZ:
                            yg = yg.times(1.5 * 1.5);
                            break;
                    }
                } else {
                    lose_yg--;
                }
                outputLines.push(`EX${curLevel}æœˆå…‰ï¼š${formatScientific(yg)}`);
            }

            // è®¡ç®—æ€»ç•ªæ•°å’Œåˆ†æ•°
            let zhiShuFan = new Decimal(1);

            // åªåœ¨æŠ¤èº«ç¬¦å¯ç”¨æ—¶è®¡ç®—å¯¹åº”éƒ¨åˆ†ï¼ŒæŠ¤èº«ç¬¦å¯ç”¨å¹¶ä¸”ä¸æ˜¯ç¬¬ä¸€æ¬¡å¯ç”¨
            if (talismanEnabled.dy && !dy_first) {
                zhiShuFan = zhiShuFan.times(dy.pow(dy_times));
            }
            if (talismanEnabled.fz && !fz_first) {
                zhiShuFan = zhiShuFan.times(fz.pow(fz_times));
            }
            if (talismanEnabled.yg && !yg_first) {
                zhiShuFan = zhiShuFan.times(yg.pow(yg_times));
            }
            if (talismanEnabled?.dy_first) {
                dy_first = false;
            }
            if (talismanEnabled?.fz_first) {
                fz_first = false;
            }
            if (talismanEnabled?.yg_first) {
                yg_first = false;
            }

            // æ·»åŠ è‡ªå®šä¹‰æŠ¤èº«ç¬¦å‚æ•°çš„è®¡ç®—
            if (customizedParams && customizedParams.length > 0) {
                customizedParams.forEach((param, index) => {
                    if (param.value && param.times) {
                        zhiShuFan = zhiShuFan.times(param.value.pow(param.times));
                    }
                });
            }

            const totalFan = zhiShuFan.times(basicFan);
            const totalScore = totalFan.times(basicScore);

            outputLines.push(`----EX${curLevel}åˆ†æ•°ï¼š${formatScientific(totalScore)}`);

            // æ£€æŸ¥å½“å‰å…³å¡æ˜¯å¦èƒ½é€šè¿‡,å¦‚æœä¸èƒ½é€šè¿‡ï¼Œå°±æ²¡æœ‰ä¸‹ä¸€é˜¶æ®µäº†
            if (totalScore.lt(REQUIRED_SCORE[curLevel - 1])) {
                outputLines.push(
                    `<span class="highlight">æ— æ³•è¾¾åˆ°EX${curLevel}çš„è¦æ±‚åˆ†æ•° ${REQUIRED_SCORE[curLevel - 1]}</span>`
                );
                if (stageName) {
                    // ä¿®æ­£æ¨è¿›å…³å¡æ•°è®¡ç®—é€»è¾‘
                    const stagesAdvanced = curLevel - startLevel;
                    outputLines.push(`<span class="highlight">æœ¬é˜¶æ®µæ¨è¿›: ${stagesAdvanced} å…³</span>`);
                }
                console.log("Setting hasNextStage to false at level EX" + curLevel);
                hasNextStage = false;
                return {
                    nextLevel: curLevel,
                    dy: dy,
                    fz: fz,
                    yg: yg,
                    outputLines: outputLines
                };
            }

            // æ£€æŸ¥æ˜¯å¦èƒ½è¿›å…¥ä¸‹ä¸€å…³ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæˆé•¿åçš„åˆ†æ•°ä¸ä¸‹ä¸€å…³è¦æ±‚åˆ†æ•°æ¯”è¾ƒï¼‰
            // æ¨¡æ‹Ÿä¸€æ¬¡æˆé•¿åçš„åˆ†æ•°ï¼Œä½†ä¸å®é™…åº”ç”¨æˆé•¿
            let simulatedDy = dy;
            let simulatedFz = fz;
            let simulatedYg = yg;

            // æ¨¡æ‹Ÿç›—å°æˆé•¿ - åªåœ¨ç›—å°æŠ¤èº«ç¬¦å¯ç”¨æ—¶å¤„ç†
            if (talismanEnabled.dy) {
                switch (dy_type) {
                    case DY_TYPE_KW_PZ:
                        simulatedDy = simulatedDy.times(Math.pow(1.3, 4));
                        break;
                    case DY_TYPE_OTHER_PZ:
                        simulatedDy = simulatedDy.times(Math.pow(1.3, 2));
                        break;
                    case DY_TYPE_NORMAL:
                        simulatedDy = simulatedDy.times(1.3);
                        break;
                }
            }

            // æ¨¡æ‹Ÿè´Ÿé‡æˆé•¿ï¼ˆä¸è€ƒè™‘äºè´Ÿé‡ï¼‰- åªåœ¨è´Ÿé‡æŠ¤èº«ç¬¦å¯ç”¨æ—¶å¤„ç†
            if (talismanEnabled.fz) {
                switch (fz_type) {
                    case FZ_TYPE_NORMAL:
                        simulatedFz = simulatedFz.times(1.5);
                        break;
                    case FZ_TYPE_TS:
                        simulatedFz = simulatedFz.times(2);
                        break;
                    case FZ_TYPE_PZ:
                        simulatedFz = simulatedFz.times(1.5 * 1.5);
                        break;
                }
            }

            // æ¨¡æ‹Ÿæœˆå…‰æˆé•¿ï¼ˆä¸è€ƒè™‘äºæœˆå…‰ï¼‰- åªåœ¨æœˆå…‰æŠ¤èº«ç¬¦å¯ç”¨æ—¶å¤„ç†
            if (talismanEnabled.yg) {
                switch (yg_type) {
                    case YG_TYPE_NORMAL:
                        simulatedYg = simulatedYg.times(1.5);
                        break;
                    case YG_TYPE_TS:
                        simulatedYg = simulatedYg.times(2);
                        break;
                    case YG_TYPE_PZ:
                        simulatedYg = simulatedYg.times(1.5 * 1.5);
                        break;
                }
            }

            // è®¡ç®—æ¨¡æ‹Ÿæˆé•¿åçš„æ€»ç•ªæ•°å’Œåˆ†æ•°
            let simulatedZhiShuFan = new Decimal(1);

            // åªåœ¨æŠ¤èº«ç¬¦å¯ç”¨æ—¶è®¡ç®—å¯¹åº”éƒ¨åˆ†
            if (talismanEnabled.dy) {
                simulatedZhiShuFan = simulatedZhiShuFan.times(simulatedDy.pow(dy_times));
            }
            if (talismanEnabled.fz) {
                simulatedZhiShuFan = simulatedZhiShuFan.times(simulatedFz.pow(fz_times));
            }
            if (talismanEnabled.yg) {
                simulatedZhiShuFan = simulatedZhiShuFan.times(simulatedYg.pow(yg_times));
            }

            // æ·»åŠ è‡ªå®šä¹‰æŠ¤èº«ç¬¦å‚æ•°çš„è®¡ç®—
            if (customizedParams && customizedParams.length > 0) {
                customizedParams.forEach((param, index) => {
                    if (param.value && param.times) {
                        simulatedZhiShuFan = simulatedZhiShuFan.times(param.value.pow(param.times));
                    }
                });
            }

            const simulatedTotalFan = simulatedZhiShuFan.times(basicFan);
            const simulatedTotalScore = simulatedTotalFan.times(basicScore);

            // æ£€æŸ¥æ˜¯å¦èƒ½è¿›å…¥ä¸‹ä¸€å…³ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæˆé•¿åçš„åˆ†æ•°ä¸ä¸‹ä¸€å…³è¦æ±‚åˆ†æ•°æ¯”è¾ƒï¼‰
            if (simulatedTotalScore.lt(REQUIRED_SCORE[curLevel])) {
                toNextStage = true;
                outputLines.push(
                    `<span class="highlight">æ— æ³•è¾¾åˆ°EX${curLevel + 1}çš„è¦æ±‚åˆ†æ•° ${REQUIRED_SCORE[curLevel]}</span>`
                );
                if (stageName) {
                    // ä¿®æ­£æ¨è¿›å…³å¡æ•°è®¡ç®—é€»è¾‘ï¼ŒåŠ 1
                    const stagesAdvanced = curLevel - startLevel + 1;
                    outputLines.push(`<span class="highlight">æœ¬é˜¶æ®µæ¨è¿›: ${stagesAdvanced} å…³</span>`);
                }
            }

            // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸‹ä¸€é˜¶æ®µçš„å®é™…å¼€å§‹å…³å¡-1ï¼ˆå¦‚æœæŒ‡å®šäº†ä¸‹ä¸€é˜¶æ®µçš„å®é™…å¼€å§‹å…³å¡ï¼‰
            if (nextStageActualLevel !== 0 && curLevel >= nextStageActualLevel - 1) {
                toNextStage = true;
                outputLines.push(
                    `<span class="highlight">å·²è¾¾åˆ°ä¸‹ä¸€é˜¶æ®µå®é™…å¼€å§‹å…³å¡-1 (EX${nextStageActualLevel - 1})ï¼Œç»“æŸå½“å‰é˜¶æ®µ</span>`);
                if (stageName) {
                    const stagesAdvanced = curLevel - startLevel + 1;
                    outputLines.push(`<span class="highlight">æœ¬é˜¶æ®µæ¨è¿›: ${stagesAdvanced} å…³</span>`);
                }
            }

            curLevel = curLevel + 1;

            // æ­£å¸¸ç›—å°æˆé•¿ - åªåœ¨ç›—å°æŠ¤èº«ç¬¦å¯ç”¨æ—¶å¤„ç†
            if (talismanEnabled.dy) {
                switch (dy_type) {
                    case DY_TYPE_KW_PZ:
                        dy = dy.times(Math.pow(1.3, 4));
                        break;
                    case DY_TYPE_OTHER_PZ:
                        dy = dy.times(Math.pow(1.3, 2));
                        break;
                    case DY_TYPE_NORMAL:
                        dy = dy.times(1.3);
                        break;
                }

                // å¤„ç†åƒè¿·é›¾æ¬¡æ•° - åªåœ¨ç¬¬ä¸€æ¬¡å¾ªç¯ä¸­å¤„ç†
                if (isFirstLoop && eat_fog > 0) {
                    for (let i = 0; i < eat_fog; i++) {
                        dy = dy.times(Math.pow(1.3, 2));
                    }
                    eat_fog = 0; // åƒè¿·é›¾æ¬¡æ•°è®¾ä¸º0
                }
            }

            isFirstLoop = false; // ç¬¬ä¸€æ¬¡å¾ªç¯ç»“æŸ

            // é˜²æ­¢æ— é™å¾ªç¯
            if (curLevel >= REQUIRED_SCORE.length) {
                toNextStage = true;
                outputLines.push(`<span class="highlight">å·²è¾¾åˆ°æœ€é«˜å…³å¡EX${curLevel}</span>`);
            }
        }

        return {
            nextLevel: curLevel,
            dy: dy,
            fz: fz,
            yg: yg,
            outputLines: outputLines
        };
    }

    // æ·»åŠ è‡ªå®šä¹‰æŠ¤èº«ç¬¦
    function addCustomParam() {
        const paramId = `customParam${customParamCounter}`;

        const customParamHTML = `
    <div class="custom-param-group" id="${paramId}">
        <div class="custom-param-header">
            <input type="text" class="custom-param-name" value="è‡ªå®šä¹‰æŠ¤èº«ç¬¦${customParamCounter}">
            <button type="button" class="remove-custom-param" onclick="removeCustomParam('${paramId}')">Ã—</button>
        </div>
        <div class="custom-param-inputs">
            <label>ä¹˜</label>
            <input type="text" class="custom-param-value" value="1">
            <label>ç•ª</label>
            <label>æ¬¡æ•°</label>
            <input type="number" class="custom-param-times" value="1" min="0" required>
        </div>
    </div>
`;

        document.getElementById('customParamsContainer').insertAdjacentHTML('beforeend', customParamHTML);

        // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼Œå®ç°åŒå‘åŒæ­¥
        const paramElement = document.getElementById(paramId);
        const nameInput = paramElement.querySelector('.custom-param-name');
        const valueInput = paramElement.querySelector('.custom-param-value');
        const timesInput = paramElement.querySelector('.custom-param-times');

        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼ŒåŒæ­¥åˆ°é˜¶æ®µ1
        [nameInput, valueInput, timesInput].forEach(input => {
            input.addEventListener('input', function () {
                syncTopCustomParamsToStage1();
            });
        });

        customParamCounter++;

        // åŒæ­¥åˆ°é˜¶æ®µ1
        syncTopCustomParamsToStage1();
    }

    // åŒæ­¥é¡¶éƒ¨è‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°é˜¶æ®µ1
    function syncTopCustomParamsToStage1() {
        const stage1 = document.querySelector('.strategy-stage');
        if (!stage1) return;

        const stageCustomParamsContainer = stage1.querySelector('.stage-custom-params-container');
        if (!stageCustomParamsContainer) return;

        // æ¸…ç©ºé˜¶æ®µ1çš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦
        stageCustomParamsContainer.innerHTML = '';

        // è·å–é¡¶éƒ¨çš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦
        const topCustomParams = document.querySelectorAll('.custom-param-group');

        // é‡æ–°æ·»åŠ æ‰€æœ‰è‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°é˜¶æ®µ1
        topCustomParams.forEach((param, index) => {
            const nameInput = param.querySelector('.custom-param-name');
            const valueInput = param.querySelector('.custom-param-inputs input[type="text"]');
            const timesInput = param.querySelector('.custom-param-inputs input[type="number"]');

            if (nameInput && valueInput && timesInput) {
                addStageCustomParamToContainer(
                    stageCustomParamsContainer,
                    nameInput.value,
                    valueInput.value,
                    timesInput.value
                );
            }
        });
    }

    // æ·»åŠ é˜¶æ®µè‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°æŒ‡å®šå®¹å™¨
    function addStageCustomParamToContainer(container, name = "", value = "1", times = "1") {
        const paramId = `stageCustomParam${Date.now()}`;

        const customParamHTML = `
    <div class="stage-custom-param-group" id="${paramId}">
        <div class="stage-custom-param-inputs">
            <input type="text" class="stage-custom-param-name" value="${name}" placeholder="æŠ¤èº«ç¬¦åç§°">
            <label>ä¹˜</label>
            <input type="text" class="stage-custom-param-value" value="${value}">
            <label>ç•ª</label>
            <label>æ¬¡æ•°</label>
            <input type="number" class="stage-custom-param-times" value="${times}" min="0" required>
        </div>
        <button type="button" class="stage-remove-custom-param" onclick="removeStageCustomParam('${paramId}')">Ã—</button>
    </div>
`;

        container.insertAdjacentHTML('beforeend', customParamHTML);

        // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼Œå®ç°åŒå‘åŒæ­¥
        const paramElement = document.getElementById(paramId);
        const nameInput = paramElement.querySelector('.stage-custom-param-name');
        const valueInput = paramElement.querySelector('.stage-custom-param-value');
        const timesInput = paramElement.querySelector('.stage-custom-param-times');

        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼ŒåŒæ­¥åˆ°é¡¶éƒ¨
        [nameInput, valueInput, timesInput].forEach(input => {
            input.addEventListener('input', function () {
                syncStage1CustomParamsToTop();
            });
        });

        return paramId;
    }

    // æ·»åŠ é˜¶æ®µè‡ªå®šä¹‰æŠ¤èº«ç¬¦
    function addStageCustomParam(stageId) {
        const container = document.getElementById(`stageCustomParams-${stageId}`);
        if (!container) return;

        // è·å–å½“å‰é˜¶æ®µçš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦æ•°é‡ï¼Œç”¨äºå‘½å
        const currentCount = container.querySelectorAll('.stage-custom-param-group').length + 1;
        const paramId = addStageCustomParamToContainer(
            container,
            `è‡ªå®šä¹‰æŠ¤èº«ç¬¦${currentCount}`,
            "1",
            "1"
        );

        // å¦‚æœæ˜¯é˜¶æ®µ1ï¼ŒåŒæ­¥åˆ°é¡¶éƒ¨
        if (stageId === 'stage1') {
            syncStage1CustomParamsToTop();
        }
    }

    // åŒæ­¥é˜¶æ®µ1è‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°é¡¶éƒ¨
    function syncStage1CustomParamsToTop() {
        const stage1 = document.querySelector('.strategy-stage');
        if (!stage1) return;

        const stageCustomParamsContainer = stage1.querySelector('.stage-custom-params-container');
        if (!stageCustomParamsContainer) return;

        // æ¸…ç©ºé¡¶éƒ¨çš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦
        document.getElementById('customParamsContainer').innerHTML = '';

        // è·å–é˜¶æ®µ1çš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦
        const stageCustomParams = stageCustomParamsContainer.querySelectorAll('.stage-custom-param-group');

        // é‡æ–°æ·»åŠ æ‰€æœ‰è‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°é¡¶éƒ¨
        stageCustomParams.forEach((param, index) => {
            const nameInput = param.querySelector('.stage-custom-param-name');
            const valueInput = param.querySelector('.stage-custom-param-value');
            const timesInput = param.querySelector('.stage-custom-param-times');

            if (nameInput && valueInput && timesInput) {
                addCustomParamToTop(
                    nameInput.value,
                    valueInput.value,
                    timesInput.value
                );
            }
        });
    }

    // æ·»åŠ è‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°é¡¶éƒ¨
    function addCustomParamToTop(name = "", value = "1", times = "1") {
        const paramId = `customParam${customParamCounter}`;

        const customParamHTML = `
    <div class="custom-param-group" id="${paramId}">
        <div class="custom-param-header">
            <input type="text" class="custom-param-name" value="${name}">
            <button type="button" class="remove-custom-param" onclick="removeCustomParam('${paramId}')">Ã—</button>
        </div>
        <div class="custom-param-inputs">
            <label>ä¹˜</label>
            <input type="text" class="custom-param-value" value="${value}">
            <label>ç•ª</label>
            <label>æ¬¡æ•°</label>
            <input type="number" class="custom-param-times" value="${times}" min="0" required>
        </div>
    </div>
`;

        document.getElementById('customParamsContainer').insertAdjacentHTML('beforeend', customParamHTML);

        // ç»‘å®šè¾“å…¥äº‹ä»¶ï¼Œå®ç°åŒå‘åŒæ­¥
        const paramElement = document.getElementById(paramId);
        const nameInput = paramElement.querySelector('.custom-param-name');
        const valueInput = paramElement.querySelector('.custom-param-value');
        const timesInput = paramElement.querySelector('.custom-param-times');

        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼ŒåŒæ­¥åˆ°é˜¶æ®µ1
        [nameInput, valueInput, timesInput].forEach(input => {
            input.addEventListener('input', function () {
                syncTopCustomParamsToStage1();
            });
        });

        customParamCounter++;
    }

    // åˆ é™¤è‡ªå®šä¹‰æŠ¤èº«ç¬¦
    function removeCustomParam(paramId) {
        const element = document.getElementById(paramId);
        if (element) {
            element.remove();
            // åŒæ­¥åˆ°é˜¶æ®µ1
            syncTopCustomParamsToStage1();
        }
    }

    // åˆ é™¤é˜¶æ®µè‡ªå®šä¹‰æŠ¤èº«ç¬¦
    function removeStageCustomParam(paramId) {
        const element = document.getElementById(paramId);
        if (element) {
            element.remove();
            // å¦‚æœæ˜¯é˜¶æ®µ1ï¼ŒåŒæ­¥åˆ°é¡¶éƒ¨
            const stage1 = document.querySelector('.strategy-stage');
            if (stage1 && element.closest('.strategy-stage') === stage1) {
                syncStage1CustomParamsToTop();
            }
        }
    }

    // æ›´æ–°é˜¶æ®µæŠ¤èº«ç¬¦å†…å®¹æ˜¾ç¤ºçŠ¶æ€
    function updateStageTalismanContent(stageElement, talismanType, isEnabled) {
        const content = stageElement.querySelector(`.talisman-card:nth-child(${getTalismanCardIndex(talismanType)}) .talisman-content`);
        if (content) {
            if (isEnabled) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        }
    }

    // è·å–æŠ¤èº«ç¬¦å¡ç‰‡åœ¨é˜¶æ®µä¸­çš„ç´¢å¼•
    function getTalismanCardIndex(talismanType) {
        const types = {dy: 3, fz: 4, yg: 5}; // é˜¶æ®µå†…å®¹ä¸­æŠ¤èº«ç¬¦å¡ç‰‡çš„é¡ºåº
        return types[talismanType] || 3;
    }

    // æ›´æ–°é¡¶éƒ¨æŠ¤èº«ç¬¦å†…å®¹æ˜¾ç¤ºçŠ¶æ€
    function updateTopTalismanContent(talismanType, isEnabled) {
        const content = document.querySelector(`#${talismanType}TalismanCard .talisman-content`);
        if (content) {
            if (isEnabled) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }
        }
    }

    // åŒæ­¥é¡¶éƒ¨æŠ¤èº«ç¬¦çŠ¶æ€åˆ°é˜¶æ®µ1
    function syncTalismanStateToStage1() {
        const stage1 = document.querySelector('.strategy-stage');
        if (!stage1) return;

        const stageDyEnabled = stage1.querySelector('.stage-dy-enabled');
        const stageFzEnabled = stage1.querySelector('.stage-fz-enabled');
        const stageYgEnabled = stage1.querySelector('.stage-yg-enabled');

        if (stageDyEnabled) {
            stageDyEnabled.checked = document.getElementById('dyTalismanEnabled').checked;
            updateStageTalismanContent(stage1, 'dy', stageDyEnabled.checked);
        }

        if (stageFzEnabled) {
            stageFzEnabled.checked = document.getElementById('fzTalismanEnabled').checked;
            updateStageTalismanContent(stage1, 'fz', stageFzEnabled.checked);
        }

        if (stageYgEnabled) {
            stageYgEnabled.checked = document.getElementById('ygTalismanEnabled').checked;
            updateStageTalismanContent(stage1, 'yg', stageYgEnabled.checked);
        }
    }

    // åŒæ­¥é˜¶æ®µ1æŠ¤èº«ç¬¦çŠ¶æ€åˆ°é¡¶éƒ¨
    function syncStage1TalismanStateToTop() {
        const stage1 = document.querySelector('.strategy-stage');
        if (!stage1) return;

        const stageDyEnabled = stage1.querySelector('.stage-dy-enabled');
        const stageFzEnabled = stage1.querySelector('.stage-fz-enabled');
        const stageYgEnabled = stage1.querySelector('.stage-yg-enabled');

        if (stageDyEnabled) {
            document.getElementById('dyTalismanEnabled').checked = stageDyEnabled.checked;
            updateTopTalismanContent('dy', stageDyEnabled.checked);
        }

        if (stageFzEnabled) {
            document.getElementById('fzTalismanEnabled').checked = stageFzEnabled.checked;
            updateTopTalismanContent('fz', stageFzEnabled.checked);
        }

        if (stageYgEnabled) {
            document.getElementById('ygTalismanEnabled').checked = stageYgEnabled.checked;
            updateTopTalismanContent('yg', stageYgEnabled.checked);
        }
    }

    // åœ¨initå‡½æ•°ä¸­æ·»åŠ æŠ¤èº«ç¬¦å¼€å…³çš„ç›‘å¬äº‹ä»¶
    function setupTalismanToggles() {
        // é¡¶éƒ¨æŠ¤èº«ç¬¦å¼€å…³
        document.getElementById('dyTalismanEnabled').addEventListener('change', function () {
            const content = document.querySelector('#dyTalismanCard .talisman-content');
            if (this.checked) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }

            // åŒæ­¥åˆ°é˜¶æ®µ1
            syncTalismanStateToStage1();
        });

        document.getElementById('fzTalismanEnabled').addEventListener('change', function () {
            const content = document.querySelector('#fzTalismanCard .talisman-content');
            if (this.checked) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }

            // åŒæ­¥åˆ°é˜¶æ®µ1
            syncTalismanStateToStage1();
        });

        document.getElementById('ygTalismanEnabled').addEventListener('change', function () {
            const content = document.querySelector('#ygTalismanCard .talisman-content');
            if (this.checked) {
                content.classList.remove('hidden');
            } else {
                content.classList.add('hidden');
            }

            // åŒæ­¥åˆ°é˜¶æ®µ1
            syncTalismanStateToStage1();
        });
    }

    // ä¸ºç­–ç•¥é˜¶æ®µå®¹å™¨æ·»åŠ äº‹ä»¶å§”æ‰˜ï¼Œå¤„ç†é˜¶æ®µå†…æŠ¤èº«ç¬¦å¼€å…³çš„å˜åŒ–
    function setupStageTalismanToggles() {
        document.getElementById('strategyStagesContainer').addEventListener('change', function (e) {
            if (e.target.classList.contains('stage-dy-enabled') ||
                e.target.classList.contains('stage-fz-enabled') ||
                e.target.classList.contains('stage-yg-enabled')) {

                const stageElement = e.target.closest('.strategy-stage');
                const talismanType = e.target.classList.contains('stage-dy-enabled') ? 'dy' :
                    e.target.classList.contains('stage-fz-enabled') ? 'fz' : 'yg';

                updateStageTalismanContent(stageElement, talismanType, e.target.checked);

                // å¦‚æœæ˜¯é˜¶æ®µ1ï¼ŒåŒæ­¥åˆ°é¡¶éƒ¨
                if (stageElement.id === 'stage1') {
                    syncStage1TalismanStateToTop();
                }
            }
        });
    }

    // æ·»åŠ ç­–ç•¥é˜¶æ®µ
    function addStrategyStage(stageData = null) {
        const stageId = `stage${stageCounter}`;
        const stageNumber = stageCounter;

        // è·å–é¡¶éƒ¨å‚æ•°çš„å½“å‰å€¼ä½œä¸ºé»˜è®¤å€¼
        const defaultDyType = document.getElementById('dy_type').value;
        const defaultFzType = document.getElementById('fz_type').value;
        const defaultYgType = document.getElementById('yg_type').value;
        const defaultBasicFan = document.getElementById('basicFan').value;
        const defaultBasicScore = document.getElementById('basicScore').value;
        const defaultDyTimes = document.getElementById('dy_times').value;
        const defaultFzTimes = document.getElementById('fz_times').value;
        const defaultYgTimes = document.getElementById('yg_times').value;
        const defaultEatFog = document.getElementById('eat_fog').value;
        const defaultLoseFz = document.getElementById('lose_fz').value;
        const defaultLoseYg = document.getElementById('lose_yg').value;
        const defaultDyEnabled = document.getElementById('dyTalismanEnabled').checked;
        const defaultFzEnabled = document.getElementById('fzTalismanEnabled').checked;
        const defaultYgEnabled = document.getElementById('ygTalismanEnabled').checked;

        const stageHTML = `
        <div class="strategy-stage" id="${stageId}">
            <div class="stage-header">
                <div class="stage-title">é˜¶æ®µ ${stageNumber}</div>
                <button type="button" class="remove-stage" onclick="removeStage('${stageId}')">Ã—</button>
            </div>
            <div class="stage-content">
                <div class="stage-form-group">
                    <label>é˜¶æ®µåç§°</label>
                    <input type="text" class="stage-name" value="${stageData?.name || `é˜¶æ®µ${stageNumber}`}" placeholder="é˜¶æ®µåç§°">
                </div>
                <div class="stage-form-group">
                    <label>å®é™…å¼€å§‹å…³å¡</label>
                    <input type="number" class="actual-level actual-level-input" value="${stageData?.actualLevel || ''}" placeholder="ä¸å¡«åˆ™ä½¿ç”¨å‰ä¸€é˜¶æ®µæé™" min="1" max="163">
                </div>

                <!-- ç›—å°æŠ¤èº«ç¬¦å¡ç‰‡ -->
                <div class="talisman-card">
                    <div class="talisman-header">
                        <div class="talisman-title">æŠ¤èº«ç¬¦ - ç›—å°</div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="stage-dy-enabled" ${(stageData?.dy_enabled !== undefined ? stageData.dy_enabled : defaultDyEnabled) ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="talisman-content">
                        <div class="stage-form-group">
                            <label>ç›—å°ç±»å‹</label>
                            <select class="dy-type">
                                <option value="æ™®é€šç›—å°" ${(stageData?.dy_type || defaultDyType) === 'æ™®é€šç›—å°' ? 'selected' : ''}>æ™®é€šç›—å°</option>
                                <option value="å¡ç»´è†¨èƒ€ç›—å°" ${(stageData?.dy_type || defaultDyType) === 'å¡ç»´è†¨èƒ€ç›—å°' ? 'selected' : ''}>å¡ç»´è†¨èƒ€ç›—å°</option>
                                <option value="å…¶ä»–å¡è†¨èƒ€ç›—å°" ${(stageData?.dy_type || defaultDyType) === 'å…¶ä»–å¡è†¨èƒ€ç›—å°' ? 'selected' : ''}>å…¶ä»–å¡è†¨èƒ€ç›—å°</option>
                            </select>
                        </div>
                        <div class="stage-form-group">
                            <label>ç›—å°æ¬¡æ•°</label>
                            <input type="number" class="dy-times" value="${stageData?.dy_times || defaultDyTimes}" min="0">
                        </div>
                        <div class="stage-form-group">
                            <label>åƒè¿·é›¾æ¬¡æ•°</label>
                            <input type="number" class="eat-fog" value="${stageData?.eat_fog ?? defaultEatFog}" min="0">
                        </div>
                    </div>
                </div>

                <!-- è´Ÿé‡æŠ¤èº«ç¬¦å¡ç‰‡ -->
                <div class="talisman-card">
                    <div class="talisman-header">
                        <div class="talisman-title">æŠ¤èº«ç¬¦ - è´Ÿé‡</div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="stage-fz-enabled" ${(stageData?.fz_enabled !== undefined ? stageData.fz_enabled : defaultFzEnabled) ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="talisman-content">
                        <div class="stage-form-group">
                            <label>è´Ÿé‡ç±»å‹</label>
                            <select class="fz-type">
                                <option value="è†¨èƒ€è´Ÿé‡" ${(stageData?.fz_type || defaultFzType) === 'è†¨èƒ€è´Ÿé‡' ? 'selected' : ''}>è†¨èƒ€è´Ÿé‡</option>
                                <option value="å¤©ä½¿è´Ÿé‡" ${(stageData?.fz_type || defaultFzType) === 'å¤©ä½¿è´Ÿé‡' ? 'selected' : ''}>å¤©ä½¿è´Ÿé‡</option>
                                <option value="æ™®é€šè´Ÿé‡" ${(stageData?.fz_type || defaultFzType) === 'æ™®é€šè´Ÿé‡' ? 'selected' : ''}>æ™®é€šè´Ÿé‡</option>
                            </select>
                        </div>
                        <div class="stage-form-group">
                            <label>è´Ÿé‡æ¬¡æ•°</label>
                            <input type="number" class="fz-times" value="${stageData?.fz_times || defaultFzTimes}" min="0">
                        </div>
                        <div class="stage-form-group">
                            <label>äºè´Ÿé‡æ¬¡æ•°</label>
                            <input type="number" class="lose-fz" value="${stageData?.lose_fz ?? defaultLoseFz}" min="0">
                        </div>
                    </div>
                </div>

                <!-- æœˆå…‰æŠ¤èº«ç¬¦å¡ç‰‡ -->
                <div class="talisman-card">
                    <div class="talisman-header">
                        <div class="talisman-title">æŠ¤èº«ç¬¦ - æœˆå…‰</div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="stage-yg-enabled" ${(stageData?.yg_enabled !== undefined ? stageData.yg_enabled : defaultYgEnabled) ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="talisman-content">
                        <div class="stage-form-group">
                            <label>æœˆå…‰ç±»å‹</label>
                            <select class="yg-type">
                                <option value="æ™®é€šæœˆå…‰" ${(stageData?.yg_type || defaultYgType) === 'æ™®é€šæœˆå…‰' ? 'selected' : ''}>æ™®é€šæœˆå…‰</option>
                                <option value="è†¨èƒ€æœˆå…‰" ${(stageData?.yg_type || defaultYgType) === 'è†¨èƒ€æœˆå…‰' ? 'selected' : ''}>è†¨èƒ€æœˆå…‰</option>
                                <option value="å¤©ä½¿æœˆå…‰" ${(stageData?.yg_type || defaultYgType) === 'å¤©ä½¿æœˆå…‰' ? 'selected' : ''}>å¤©ä½¿æœˆå…‰</option>
                            </select>
                        </div>
                        <div class="stage-form-group">
                            <label>æœˆå…‰æ¬¡æ•°</label>
                            <input type="number" class="yg-times" value="${stageData?.yg_times || defaultYgTimes}" min="0">
                        </div>
                        <div class="stage-form-group">
                            <label>äºæœˆå…‰æ¬¡æ•°</label>
                            <input type="number" class="lose-yg" value="${stageData?.lose_yg ?? defaultLoseYg}" min="0">
                        </div>
                    </div>
                </div>

                <div class="stage-form-group basic-fan-group">
                    <label>åŸºç¡€ç•ªæ•°</label>
                    <input type="number" class="basic-fan" value="${stageData?.basicFan || defaultBasicFan}" min="1">
                </div>
                <div class="stage-form-group basic-score-group">
                    <label>åŸºç¡€åˆ†æ•°</label>
                    <input type="number" class="basic-score" value="${stageData?.basicScore || defaultBasicScore}" min="1">
                </div>
                <div class="stage-form-group" style="grid-column: 1 / -1;">
                    <button type="button" class="add-stage-custom-param-btn strategy-btn" onclick="addStageCustomParam('${stageId}')">
                        <span class="add-icon">+</span> æ·»åŠ è‡ªå®šä¹‰æŠ¤èº«ç¬¦
                    </button>
                    <div class="stage-custom-params-container" id="stageCustomParams-${stageId}">
                        <!-- é˜¶æ®µè‡ªå®šä¹‰æŠ¤èº«ç¬¦å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>
    `;

        document.getElementById('strategyStagesContainer').insertAdjacentHTML('beforeend', stageHTML);
        // è®¾ç½®é˜¶æ®µæŠ¤èº«ç¬¦å†…å®¹çš„åˆå§‹æ˜¾ç¤ºçŠ¶æ€
        const stageElement = document.getElementById(stageId);
        if (stageElement) {
            const stageDyEnabled = stageElement.querySelector('.stage-dy-enabled');
            const stageFzEnabled = stageElement.querySelector('.stage-fz-enabled');
            const stageYgEnabled = stageElement.querySelector('.stage-yg-enabled');

            if (stageDyEnabled) {
                updateStageTalismanContent(stageElement, 'dy', stageDyEnabled.checked);
            }

            if (stageFzEnabled) {
                updateStageTalismanContent(stageElement, 'fz', stageFzEnabled.checked);
            }

            if (stageYgEnabled) {
                updateStageTalismanContent(stageElement, 'yg', stageYgEnabled.checked);
            }
        }

        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œè®¾ç½®åŒå‘ç»‘å®š
        if (stageNumber === 1) {
            setupStage1Binding(stageId);

            // åŒæ­¥é¡¶éƒ¨çš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦åˆ°é˜¶æ®µ1
            syncTopCustomParamsToStage1();
        }

        stageCounter++;
    }

    // è®¾ç½®é˜¶æ®µ1ä¸é¡¶éƒ¨å‚æ•°çš„åŒå‘ç»‘å®š
    function setupStage1Binding(stageId) {
        const stageElement = document.getElementById(stageId);

        // è·å–é˜¶æ®µ1çš„å…ƒç´ 
        const stageDyType = stageElement.querySelector('.dy-type');
        const stageFzType = stageElement.querySelector('.fz-type');
        const stageYgType = stageElement.querySelector('.yg-type');
        const stageBasicFan = stageElement.querySelector('.basic-fan');
        const stageBasicScore = stageElement.querySelector('.basic-score');
        const stageDyTimes = stageElement.querySelector('.dy-times');
        const stageFzTimes = stageElement.querySelector('.fz-times');
        const stageYgTimes = stageElement.querySelector('.yg-times');
        const stageEatFog = stageElement.querySelector('.eat-fog');
        const stageLoseFz = stageElement.querySelector('.lose-fz');
        const stageLoseYg = stageElement.querySelector('.lose-yg');
        const stageDyEnabled = stageElement.querySelector('.stage-dy-enabled');
        const stageFzEnabled = stageElement.querySelector('.stage-fz-enabled');
        const stageYgEnabled = stageElement.querySelector('.stage-yg-enabled');

        // é˜¶æ®µ1 -> é¡¶éƒ¨å‚æ•°
        stageDyType.addEventListener('change', () => document.getElementById('dy_type').value = stageDyType.value);
        stageFzType.addEventListener('change', () => document.getElementById('fz_type').value = stageFzType.value);
        stageYgType.addEventListener('change', () => document.getElementById('yg_type').value = stageYgType.value);
        stageBasicFan.addEventListener('input', () => document.getElementById('basicFan').value = stageBasicFan.value);
        stageBasicScore.addEventListener('input', () => document.getElementById('basicScore').value = stageBasicScore
            .value);
        stageDyTimes.addEventListener('input', () => document.getElementById('dy_times').value = stageDyTimes.value);
        stageFzTimes.addEventListener('input', () => document.getElementById('fz_times').value = stageFzTimes.value);
        stageYgTimes.addEventListener('input', () => document.getElementById('yg_times').value = stageYgTimes.value);
        stageEatFog.addEventListener('input', () => document.getElementById('eat_fog').value = stageEatFog.value);
        stageLoseFz.addEventListener('input', () => document.getElementById('lose_fz').value = stageLoseFz.value);
        stageLoseYg.addEventListener('input', () => document.getElementById('lose_yg').value = stageLoseYg.value);
        stageDyEnabled.addEventListener('change', () => document.getElementById('dyTalismanEnabled').checked =
            stageDyEnabled.checked);
        stageFzEnabled.addEventListener('change', () => document.getElementById('fzTalismanEnabled').checked =
            stageFzEnabled.checked);
        stageYgEnabled.addEventListener('change', () => document.getElementById('ygTalismanEnabled').checked =
            stageYgEnabled.checked);

        // é¡¶éƒ¨å‚æ•° -> é˜¶æ®µ1
        document.getElementById('dy_type').addEventListener('change', () => stageDyType.value = document.getElementById(
            'dy_type').value);
        document.getElementById('fz_type').addEventListener('change', () => stageFzType.value = document.getElementById(
            'fz_type').value);
        document.getElementById('yg_type').addEventListener('change', () => stageYgType.value = document.getElementById(
            'yg_type').value);
        document.getElementById('basicFan').addEventListener('input', () => stageBasicFan.value = document
            .getElementById('basicFan').value);
        document.getElementById('basicScore').addEventListener('input', () => stageBasicScore.value = document
            .getElementById('basicScore').value);
        document.getElementById('dy_times').addEventListener('input', () => stageDyTimes.value = document.getElementById(
            'dy_times').value);
        document.getElementById('fz_times').addEventListener('input', () => stageFzTimes.value = document.getElementById(
            'fz_times').value);
        document.getElementById('yg_times').addEventListener('input', () => stageYgTimes.value = document.getElementById(
            'yg_times').value);
        document.getElementById('eat_fog').addEventListener('input', () => stageEatFog.value = document.getElementById(
            'eat_fog').value);
        document.getElementById('lose_fz').addEventListener('input', () => stageLoseFz.value = document.getElementById(
            'lose_fz').value);
        document.getElementById('lose_yg').addEventListener('input', () => stageLoseYg.value = document.getElementById(
            'lose_yg').value);
        document.getElementById('dyTalismanEnabled').addEventListener('change', () => stageDyEnabled.checked = document
            .getElementById('dyTalismanEnabled').checked);
        document.getElementById('fzTalismanEnabled').addEventListener('change', () => stageFzEnabled.checked = document
            .getElementById('fzTalismanEnabled').checked);
        document.getElementById('ygTalismanEnabled').addEventListener('change', () => stageYgEnabled.checked = document
            .getElementById('ygTalismanEnabled').checked);
    }

    // åˆ é™¤é˜¶æ®µ
    function removeStage(stageId) {
        const element = document.getElementById(stageId);
        if (element) {
            element.remove();
            // é‡æ–°ç¼–å·æ‰€æœ‰é˜¶æ®µ
            renumberStages();
        }
    }

    // é‡æ–°ç¼–å·é˜¶æ®µ
    function renumberStages() {
        const stages = document.querySelectorAll('.strategy-stage');
        stageCounter = 1;
        stages.forEach((stage, index) => {
            const title = stage.querySelector('.stage-title');
            const nameInput = stage.querySelector('.stage-name');
            title.textContent = `é˜¶æ®µ ${index + 1}`;
            if (nameInput.value === `é˜¶æ®µ${stageCounter}` || nameInput.value.includes('é˜¶æ®µ')) {
                nameInput.value = `é˜¶æ®µ${index + 1}`;
            }

            // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œé‡æ–°è®¾ç½®åŒå‘ç»‘å®š
            if (index === 0) {
                setupStage1Binding(stage.id);
            }

            stageCounter++;
        });
    }

    // è·å–æ‰€æœ‰é˜¶æ®µé…ç½®
    function getAllStages() {
        const stages = [];
        const stageElements = document.querySelectorAll('.strategy-stage');

        stageElements.forEach((stageElement) => {
            const stageId = stageElement.id;
            const customizedParams = getStageCustomizedParams(stageId);

            const stageData = {
                name: stageElement.querySelector('.stage-name').value,
                actualLevel: parseInt(stageElement.querySelector('.actual-level').value) || 0,
                dy_type: stageElement.querySelector('.dy-type').value,
                fz_type: stageElement.querySelector('.fz-type').value,
                yg_type: stageElement.querySelector('.yg-type').value,
                basicFan: parseInt(stageElement.querySelector('.basic-fan').value),
                basicScore: parseInt(stageElement.querySelector('.basic-score').value),
                dy_times: parseInt(stageElement.querySelector('.dy-times').value),
                fz_times: parseInt(stageElement.querySelector('.fz-times').value),
                yg_times: parseInt(stageElement.querySelector('.yg-times').value),
                eat_fog: parseInt(getValueOrDefault(stageElement.querySelector('.eat-fog').value, 0)),
                lose_fz: parseInt(getValueOrDefault(stageElement.querySelector('.lose-fz').value, 0)),
                lose_yg: parseInt(getValueOrDefault(stageElement.querySelector('.lose-yg').value, 0)),
                dy_enabled: stageElement.querySelector('.stage-dy-enabled').checked,
                fz_enabled: stageElement.querySelector('.stage-fz-enabled').checked,
                yg_enabled: stageElement.querySelector('.stage-yg-enabled').checked,
                customizedParams: customizedParams
            };

            stages.push(stageData);
        });

        return stages;
    }

    // è·å–é˜¶æ®µè‡ªå®šä¹‰æŠ¤èº«ç¬¦å‚æ•°
    function getStageCustomizedParams(stageId) {
        const container = document.getElementById(`stageCustomParams-${stageId}`);
        if (!container) return [];

        const customParams = [];
        const customParamGroups = container.querySelectorAll('.stage-custom-param-group');

        customParamGroups.forEach((group, index) => {
            const timesInput = group.querySelector('.stage-custom-param-times');
            const valueInput = group.querySelector('.stage-custom-param-value');

            if (valueInput && timesInput) {
                try {
                    const value = parseValue(valueInput.value);
                    const times = parseInt(timesInput.value) || 0;

                    if (value && !isNaN(times)) {
                        customParams.push({
                            value: value,
                            times: times
                        });
                    }
                } catch (error) {
                    console.error('è§£æé˜¶æ®µè‡ªå®šä¹‰å‚æ•°é”™è¯¯:', error);
                }
            }
        });

        return customParams;
    }

    // è·å–æ‰€æœ‰è‡ªå®šä¹‰æŠ¤èº«ç¬¦å‚æ•°
    function getCustomizedParams() {
        const customParams = [];
        const customParamGroups = document.querySelectorAll('.custom-param-group');

        customParamGroups.forEach((group, index) => {
            const timesInput = group.querySelector('.custom-param-times');
            const valueInput = group.querySelector('.custom-param-value');
            const nameInput = group.querySelector('.custom-param-name');

            if (valueInput && timesInput && nameInput) {
                try {
                    const value = parseValue(valueInput.value);
                    const times = parseInt(timesInput.value) || 0;
                    const name = nameInput.value;

                    if (value && !isNaN(times)) {
                        customParams.push({
                            name: name,
                            value: value,
                            times: times
                        });
                    }
                } catch (error) {
                    console.error('è§£æè‡ªå®šä¹‰å‚æ•°é”™è¯¯:', error);
                }
            }
        });

        return customParams;
    }

    // è†¨èƒ€ç›—å°è†¨èƒ€è´Ÿé‡æ™®é€šæœˆå…‰ç­–ç•¥é…ç½®
    const twoInflationStrategy = [{
        name: "æ”¹ä¼ å¯¼å¡ç»´",
        actualLevel: 0,
        dy_type: "å¡ç»´è†¨èƒ€ç›—å°",
        fz_type: "è†¨èƒ€è´Ÿé‡",
        yg_type: "æ™®é€šæœˆå…‰",
        basicFan: 19,
        basicScore: 38,
        dy_times: 2,
        fz_times: 2,
        yg_times: 1,
        eat_fog: 0,
        lose_fz: 0,
        lose_yg: 0,
        dy_enabled: true,
        fz_enabled: true,
        yg_enabled: true
    },
        {
            name: "æ”¹å²šæ˜Ÿ",
            actualLevel: 0,
            dy_type: "å…¶ä»–å¡è†¨èƒ€ç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 38,
            dy_times: 2,
            fz_times: 2,
            yg_times: 1,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å²šæ˜Ÿå…¥é“¾",
            actualLevel: 0,
            dy_type: "å…¶ä»–å¡è†¨èƒ€ç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 38,
            dy_times: 3,
            fz_times: 2,
            yg_times: 1,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "æœˆå…‰å…¥é“¾",
            actualLevel: 0,
            dy_type: "å…¶ä»–å¡è†¨èƒ€ç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 38,
            dy_times: 3,
            fz_times: 2,
            yg_times: 3,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "ç›—å°å…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 4,
            fz_times: 2,
            yg_times: 3,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©å…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 5,
            fz_times: 2,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©ç§»åˆ°ç›—å°å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 2,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©ç§»åˆ°æœˆå…‰å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 2,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "è´Ÿé‡å…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 5,
            fz_times: 6,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©ç§»åˆ°è´Ÿé‡å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 5,
            fz_times: 7,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©ç§»åˆ°ç›—å°å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 7,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©ç§»åˆ°æœˆå…‰å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 7,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å…«é“¾æˆå‹",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 8,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "å¤©æ©ç§»åˆ°ç›—å°å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 7,
            fz_times: 8,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "æœ€ç»ˆé˜¶æ®µï¼šå¤©æ©ç§»åˆ°æœˆå…‰å‰é¢",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 7,
            fz_times: 8,
            yg_times: 6,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        }
    ];

    // åº”ç”¨è†¨èƒ€ç›—å°è†¨èƒ€è´Ÿé‡æ™®é€šæœˆå…‰ç­–ç•¥
    function applyTwoInflationStrategy() {
        // æ¸…é™¤æ‰€æœ‰ç°æœ‰é˜¶æ®µ
        document.getElementById('strategyStagesContainer').innerHTML = '';
        stageCounter = 1;

        // æ·»åŠ æ–°é˜¶æ®µ
        twoInflationStrategy.forEach(stageData => {
            addStrategyStage(stageData);
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        alert("æ­¤ä¸ºè†¨èƒ€ç›—å°+è†¨èƒ€è´Ÿé‡+æ™®é€šæœˆå…‰çš„æ ‡å‡†ç­–ç•¥ï¼›\né˜¶æ®µ2çš„å®é™…å¼€å§‹å…³å¡å°±æ˜¯æ”¹å‡ºä¼ å¯¼å¡ç»´çš„é‚£å…³ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæ²¡æ”¹å‡ºä¼ å¯¼å¡ç»´ï¼Œå°±ä¸ä¼šæ‰§è¡Œåç»­é˜¶æ®µäº†ï¼›\nå¸æ˜ŸæŒ‰ç…§1ä¸‡æ˜Ÿå¸æ¥ç®—");
    }

    // å•ç›—å°é»‘å®¢ç­–ç•¥é…ç½®
    const singleDyHackerStrategy = [
        {
            name: "å¡ç»´+è†¨èƒ€ç›—å°+é»‘å®¢",
            actualLevel: 0,
            dy_type: "å¡ç»´è†¨èƒ€ç›—å°",
            basicFan: 19,
            basicScore: 38,
            dy_times: 3,
            eat_fog: 0,
            dy_enabled: true,
            fz_enabled: false,
            yg_enabled: false
        },
        {
            name: "å²šæ˜Ÿå…¥é“¾",
            actualLevel: 0,
            dy_type: "å¡ç»´è†¨èƒ€ç›—å°",
            basicFan: 19,
            basicScore: 38,
            dy_times: 4,
            eat_fog: 0,
            dy_enabled: true,
            fz_enabled: false,
            yg_enabled: false
        },
        {
            name: "åˆ·å‡ºä¼ å¯¼å¡ç»´çš„é‚£å…³",
            actualLevel: 0,
            dy_type: "å…¶ä»–å¡è†¨èƒ€ç›—å°",
            basicFan: 19,
            basicScore: 38,
            dy_times: 4,
            eat_fog: 0,
            dy_enabled: true,
            fz_enabled: false,
            yg_enabled: false
        },
        {
            name: "å¤©æ©å…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "è†¨èƒ€è´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 19,
            basicScore: 38,
            dy_times: 4,
            eat_fog: 0,
            dy_enabled: true,
            fz_enabled: false,
            yg_enabled: false
        },
        {
            name: "è´Ÿé‡å…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            basicFan: 19,
            basicScore: 38,
            dy_times: 5,
            fz_times: 4,
            eat_fog: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: false
        },
        {
            name: "å¸æ˜Ÿå…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            basicFan: 19,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: false
        },
        {
            name: "æœˆå…‰å…¥é“¾",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 19,
            basicScore: 100000,
            dy_times: 7,
            fz_times: 6,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "8é“¾æˆå‹",
            actualLevel: 0,
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            basicFan: 19,
            basicScore: 100000,
            dy_times: 8,
            fz_times: 7,
            yg_times: 6,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        }
    ];

    // åº”ç”¨å•ç›—å°é»‘å®¢ç­–ç•¥
    function applySingleDyHackerStrategy() {
        // æ¸…é™¤æ‰€æœ‰ç°æœ‰é˜¶æ®µ
        document.getElementById('strategyStagesContainer').innerHTML = '';
        stageCounter = 1;

        // æ·»åŠ æ–°é˜¶æ®µ
        singleDyHackerStrategy.forEach(stageData => {
            addStrategyStage(stageData);
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        alert("æ­¤ä¸ºå•ç›—å°é»‘å®¢åŸºç¡€ç­–ç•¥ï¼›\nå¡ç»´åŠ è†¨èƒ€ç›—å°é˜¶æ®µï¼Œé»‘å®¢å˜ç›—å°åƒä¸€ä¸ªå°ç« æ•ˆæœç­‰åŒäºç›—å°åƒä¸€ä¸ªè¿·é›¾ï¼Œéƒ½æ˜¯æˆé•¿1.69ï¼Œæ‰€ä»¥è¿™ä¸ªç­–ç•¥ä¸­ï¼Œé»‘å®¢å˜ä¸€ä¸ªå›åˆç›—å°ï¼Œå¯ä»¥ç®—ä½œåƒä¸€æ¬¡è¿·é›¾;" +
            "\nè½¬åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µçš„å®é™…å¼€å§‹å…³å¡éœ€è¦è‡ªå·±æ ¹æ®å®é™…æƒ…å†µå¡«å†™ï¼›\nå¸æ˜Ÿå…¥é“¾æŒ‰1ä¸‡æ˜Ÿå¸æ¥ç®—ï¼›\nä¸è€ƒè™‘å¤©æ©å¾€å‰ç§»çš„æ­¥éª¤");
    }

    // å…³å¡åˆ†æ•°æ•°æ®
    const LEVEL_SCORE_DATA = [
        {level: "Ex1", score: "1.00E+06"},
        {level: "Ex2", score: "1.20E+07"},
        {level: "Ex3", score: "9.08E+07"},
        {level: "Ex4", score: "8.11E+08"},
        {level: "Ex5", score: "8.43E+09"},
        {level: "Ex6", score: "1.00E+11"},
        {level: "Ex7", score: "1.35E+12"},
        {level: "Ex8", score: "2.06E+13"},
        {level: "Ex9", score: "3.48E+14"},
        {level: "Ex10", score: "6.54E+15"},
        {level: "Ex11", score: "1.36E+17"},
        {level: "Ex12", score: "3.09E+18"},
        {level: "Ex13", score: "7.68E+19"},
        {level: "Ex14", score: "2.08E+21"},
        {level: "Ex15", score: "6.64E+22"},
        {level: "Ex16", score: "2.46E+24"},
        {level: "Ex17", score: "1.05E+26"},
        {level: "Ex18", score: "5.15E+27"},
        {level: "Ex19", score: "2.82E+29"},
        {level: "Ex20", score: "1.83E+31"},
        {level: "Ex21", score: "1.31E+33"},
        {level: "Ex22", score: "1.07E+35"},
        {level: "Ex23", score: "9.72E+36"},
        {level: "Ex24", score: "9.94E+38"},
        {level: "Ex25", score: "1.14E+41"},
        {level: "Ex26", score: "1.46E+43"},
        {level: "Ex27", score: "2.08E+45"},
        {level: "Ex28", score: "3.31E+47"},
        {level: "Ex29", score: "5.85E+49"},
        {level: "Ex30", score: "1.26E+52"},
        {level: "Ex31", score: "3.00E+54"},
        {level: "Ex32", score: "8.71E+56"},
        {level: "Ex33", score: "2.79E+59"},
        {level: "Ex34", score: "1.08E+62"},
        {level: "Ex35", score: "4.63E+64"},
        {level: "Ex36", score: "2.40E+67"},
        {level: "Ex37", score: "1.37E+70"},
        {level: "Ex38", score: "9.41E+72"},
        {level: "Ex39", score: "7.15E+75"},
        {level: "Ex40", score: "7.09E+78"},
        {level: "Ex41", score: "9.17E+81"},
        {level: "Ex42", score: "1.55E+85"},
        {level: "Ex43", score: "3.40E+88"},
        {level: "Ex44", score: "9.73E+91"},
        {level: "Ex45", score: "3.63E+95"},
        {level: "Ex46", score: "1.11E+99"},
        {level: "Ex47", score: "1.11E+103"},
        {level: "Ex48", score: "9.11E+106"},
        {level: "Ex49", score: "9.72E+110"},
        {level: "Ex50", score: "1.35E+115"},
        {level: "Ex51", score: "2.81E+119"},
        {level: "Ex52", score: "8.79E+123"},
        {level: "Ex53", score: "4.12E+128"},
        {level: "Ex54", score: "2.90E+134"},
        {level: "Ex55", score: "3.06E+138"},
        {level: "Ex56", score: "4.84E+143"},
        {level: "Ex57", score: "1.15E+149"},
        {level: "Ex58", score: "4.10E+154"},
        {level: "Ex59", score: "2.19E+160"},
        {level: "Ex60", score: "1.76E+166"},
        {level: "Ex61", score: "2.11E+172"},
        {level: "Ex62", score: "3.80E+178"},
        {level: "Ex63", score: "1.03E+185"},
        {level: "Ex64", score: "4.17E+191"},
        {level: "Ex65", score: "2.54E+198"},
        {level: "Ex66", score: "2.32E+205"},
        {level: "Ex67", score: "3.18E+212"},
        {level: "Ex68", score: "6.54E+219"},
        {level: "Ex69", score: "2.02E+227"},
        {level: "Ex70", score: "9.31E+234"},
        {level: "Ex71", score: "6.46E+242"},
        {level: "Ex72", score: "6.72E+250"},
        {level: "Ex73", score: "1.05E+259"},
        {level: "Ex74", score: "2.45E+267"},
        {level: "Ex75", score: "8.60E+275"},
        {level: "Ex76", score: "4.53E+284"},
        {level: "Ex77", score: "3.58E+293"},
        {level: "Ex78", score: "4.24E+302"},
        {level: "Ex79", score: "5.7E310"},
        {level: "Ex80", score: "5.7E318"},
        {level: "Ex81", score: "5.7E326"},
        {level: "Ex82", score: "5.7E334"},
        {level: "Ex83", score: "5.7E342"},
        {level: "Ex84", score: "5.7E350"},
        {level: "Ex85", score: "5.7E359"},
        {level: "Ex86", score: "5.7E368"},
        {level: "Ex87", score: "5.7E377"},
        {level: "Ex88", score: "5.7E386"},
        {level: "Ex89", score: "5.7E395"},
        {level: "Ex90", score: "5.7E405"},
        {level: "Ex91", score: "5.7E415"},
        {level: "Ex92", score: "5.7E425"},
        {level: "Ex93", score: "5.7E435"},
        {level: "Ex94", score: "5.7E445"},
        {level: "Ex95", score: "5.7E455"},
        {level: "Ex96", score: "5.7E466"},
        {level: "Ex97", score: "5.7E477"},
        {level: "Ex98", score: "5.7E488"},
        {level: "Ex99", score: "5.7E499"},
        {level: "Ex100", score: "9.999E510"},
        {level: "Ex101", score: "9.999E522"},
        {level: "Ex102", score: "9.999E534"},
        {level: "Ex103", score: "9.999E546"},
        {level: "Ex104", score: "9.999E558"},
        {level: "Ex105", score: "9.999E571"},
        {level: "Ex106", score: "9.999E584"},
        {level: "Ex107", score: "9.999E597"},
        {level: "Ex108", score: "9.999E611"},
        {level: "Ex109", score: "9.999E625"},
        {level: "Ex110", score: "9.999E639"},
        {level: "Ex111", score: "9.999E654"},
        {level: "Ex112", score: "9.999E669"},
        {level: "Ex113", score: "9.999E684"},
        {level: "Ex114", score: "9.999E699"},
        {level: "Ex115", score: "9.999E715"},
        {level: "Ex116", score: "9.999E731"},
        {level: "Ex117", score: "9.999E748"},
        {level: "Ex118", score: "9.999E765"},
        {level: "Ex119", score: "9.999E783"},
        {level: "Ex120", score: "9.999E801"},
        {level: "Ex121", score: "9.999E820"},
        {level: "Ex122", score: "9.999E839"},
        {level: "Ex123", score: "9.999E859"},
        {level: "Ex124", score: "9.999E879"},
        {level: "Ex125", score: "9.999E900"},
        {level: "Ex126", score: "9.999E921"},
        {level: "Ex127", score: "9.999E943"},
        {level: "Ex128", score: "9.999E966"},
        {level: "Ex129", score: "9.999E990"},
        {level: "Ex130", score: "9.999E1015"},
        {level: "Ex131", score: "9.999E1041"},
        {level: "Ex132", score: "9.999E1068"},
        {level: "Ex133", score: "9.999E1096"},
        {level: "Ex134", score: "2.9997E1126"},
        {level: "Ex135", score: "9.999E1155"},
        {level: "Ex136", score: "9.999E1186"},
        {level: "Ex137", score: "9.999E1218"},
        {level: "Ex138", score: "9.999E1251"},
        {level: "Ex139", score: "9.999E1285"},
        {level: "Ex140", score: "9.999E1320"},
        {level: "Ex141", score: "9.999E1356"},
        {level: "Ex142", score: "9.999E1393"},
        {level: "Ex143", score: "9.999E1431"},
        {level: "Ex144", score: "9.999E1470"},
        {level: "Ex145", score: "9.999E1510"},
        {level: "Ex146", score: "9.999E1551"},
        {level: "Ex147", score: "9.999E1593"},
        {level: "Ex148", score: "9.999E1636"},
        {level: "Ex149", score: "9.999E1680"},
        {level: "Ex150", score: "2.9997E1726"},
        {level: "Ex151", score: "9.999E1771"},
        {level: "Ex152", score: "9.999E1818"},
        {level: "Ex153", score: "2.9997E1867"},
        {level: "Ex154", score: "9.999E1915"},
        {level: "Ex155", score: "9.999E1965"},
        {level: "Ex156", score: "9.999E2016"},
        {level: "Ex157", score: "9.999E2068"},
        {level: "Ex158", score: "2.9997E2122"},
        {level: "Ex159", score: "9.999E2175"},
        {level: "Ex160", score: "9.999E2230"},
        {level: "Ex161", score: "9.999E2286"},
        {level: "Ex162", score: "9.999E2343"},
        {level: "Ex163", score: "9.999E2401"},
        {level: "Ex164", score: "9.999E2460"}
    ];

    // åˆå§‹åŒ–å…³å¡åˆ†æ•°è¡¨æ ¼
    function initScoreTable() {
        const tableBody = document.querySelector('#scoreTable tbody');
        tableBody.innerHTML = '';

        LEVEL_SCORE_DATA.forEach(data => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td>${data.level}</td>
            <td>${data.score}</td>
        `;
            tableBody.appendChild(row);
        });
    }

    // å…³å¡åˆ†æ•°è¡¨æ ¼åˆ‡æ¢åŠŸèƒ½
    function setupScoreTableToggle() {
        document.getElementById('toggleScoreTable').addEventListener('click', function () {
            const tableContainer = document.querySelector('.score-table-container');
            const eye = document.getElementById('toggleScoreTable');

            if (tableContainer.classList.contains('hidden')) {
                // æ˜¾ç¤ºè¡¨æ ¼
                tableContainer.classList.remove('hidden');
                eye.textContent = "ğŸ‘ï¸"; // ççœ¼å›¾æ ‡
                eye.title = "ç‚¹å‡»éšè—è¡¨æ ¼";
            } else {
                // éšè—è¡¨æ ¼
                tableContainer.classList.add('hidden');
                eye.textContent = "ğŸ™ˆ"; // é—­çœ¼å›¾æ ‡
                eye.title = "ç‚¹å‡»æ˜¾ç¤ºè¡¨æ ¼";
            }
        });
    }


    // åˆå§‹åŒ–å‡½æ•°
    function init() {
        // äº‹ä»¶ç›‘å¬
        document.getElementById('addCustomParam').addEventListener('click', addCustomParam);
        document.getElementById('addStageBtn').addEventListener('click', () => addStrategyStage({
            dy_type: "æ™®é€šç›—å°",
            fz_type: "æ™®é€šè´Ÿé‡",
            yg_type: "æ™®é€šæœˆå…‰",
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0
        }));

        // é¢„è®¾ç­–ç•¥æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('twoInflationBtn').addEventListener('click', applyTwoInflationStrategy);
        document.getElementById('singleDyHackerBtn').addEventListener('click', applySingleDyHackerStrategy);

        // å•æ¬¡è®¡ç®—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('calculateBtn').addEventListener('click', function () {
            try {
                // è·å–è¾“å…¥å€¼ï¼Œå¦‚æœä¸ºç©ºåˆ™é»˜è®¤ä¸º0
                const curLevel = parseInt(document.getElementById('curLevel').value);
                const dy = parseValue(document.getElementById('dy').value);
                const fz = parseValue(document.getElementById('fz').value);
                const yg = parseValue(document.getElementById('yg').value);
                const eat_fog = parseInt(getValueOrDefault(document.getElementById('eat_fog').value, 0));
                const lose_fz = parseInt(getValueOrDefault(document.getElementById('lose_fz').value, 0));
                const lose_yg = parseInt(getValueOrDefault(document.getElementById('lose_yg').value, 0));
                const dy_type = document.getElementById('dy_type').value;
                const fz_type = document.getElementById('fz_type').value;
                const yg_type = document.getElementById('yg_type').value;
                const basicFan = parseInt(document.getElementById('basicFan').value);
                const basicScore = parseInt(document.getElementById('basicScore').value);
                const dy_times = parseInt(document.getElementById('dy_times').value);
                const fz_times = parseInt(document.getElementById('fz_times').value);
                const yg_times = parseInt(document.getElementById('yg_times').value);

                // è·å–è‡ªå®šä¹‰æŠ¤èº«ç¬¦å‚æ•°
                const customizedParams = getCustomizedParams();

                // è·å–æŠ¤èº«ç¬¦å¯ç”¨çŠ¶æ€
                const talismanEnabled = getTalismanEnabledStates();

                // æ‰§è¡Œè®¡ç®—
                const result = executeCurrentStage(
                    curLevel, 0, 0, dy, fz, yg,
                    lose_fz, lose_yg, eat_fog,
                    dy_type, fz_type, yg_type,
                    basicFan, basicScore,
                    dy_times, fz_times, yg_times,
                    customizedParams,
                    "å½“å‰",
                    talismanEnabled
                );

                // æ›´æ–°è¾“å‡ºæ—¥å¿—
                document.getElementById('outputLog').innerHTML = result.outputLines.map(line =>
                    `<div class="output-line">${line}</div>`).join(
                    '');

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('resultText').textContent = `EX${result.nextLevel - 1}`;
            } catch (error) {
                document.getElementById('outputLog').innerHTML =
                    `<div class="output-line highlight">è¾“å…¥æ ¼å¼é”™è¯¯ï¼š${error.message}</div>`;
                document.getElementById('resultText').textContent = "è®¡ç®—å¤±è´¥";
            }
        });

        // ç­–ç•¥è®¡ç®—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('calculateStrategyBtn').addEventListener('click', function () {
            try {
                // é‡ç½® hasNextStage
                hasNextStage = true;
                // è·å–åˆå§‹å‚æ•°
                const curLevel = parseInt(document.getElementById('curLevel').value);
                let dy = parseValue(document.getElementById('dy').value);
                let fz = parseValue(document.getElementById('fz').value);
                let yg = parseValue(document.getElementById('yg').value);

                // è·å–æ‰€æœ‰é˜¶æ®µé…ç½®
                const stages = getAllStages();

                let currentLevel = curLevel;
                let allOutputLines = [];

                // å¦‚æœæ²¡æœ‰é˜¶æ®µï¼Œä½¿ç”¨é»˜è®¤å•é˜¶æ®µè®¡ç®—
                if (stages.length === 0) {
                    allOutputLines.push(`<span class="highlight">æœªé…ç½®ç­–ç•¥é˜¶æ®µï¼Œä½¿ç”¨é»˜è®¤è®¡ç®—</span>`);
                    const talismanEnabled = getTalismanEnabledStates();
                    const result = executeCurrentStage(
                        currentLevel, 0, 0, dy, fz, yg,
                        0, 0, 0,
                        "æ™®é€šç›—å°", "è†¨èƒ€è´Ÿé‡", "æ™®é€šæœˆå…‰",
                        23, 1111100,
                        6, 3, 5,
                        [],
                        "é»˜è®¤é˜¶æ®µ",
                        talismanEnabled
                    );

                    allOutputLines = allOutputLines.concat(result.outputLines);
                    currentLevel = result.nextLevel;
                    dy = result.dy;
                    fz = result.fz;
                    yg = result.yg;
                } else {
                    // æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªé˜¶æ®µ
                    for (let i = 0; i < stages.length; i++) {
                        const stage = stages[i];

                        // è·å–ä¸‹ä¸€é˜¶æ®µçš„å®é™…å¼€å§‹å…³å¡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                        const nextStageActualLevel = i + 1 < stages.length ? stages[i + 1].actualLevel : 0;

                        const talismanEnabled = {
                            dy: stage.dy_enabled,
                            fz: stage.fz_enabled,
                            yg: stage.yg_enabled
                        };

                        // å¯¹äºé˜¶æ®µ1ï¼Œä½¿ç”¨é¡¶éƒ¨è¾“å…¥çš„åˆå§‹å€¼
                        // å¯¹äºåç»­é˜¶æ®µï¼Œæ ¹æ®æŠ¤èº«ç¬¦å¯ç”¨çŠ¶æ€ç¡®å®šåˆå§‹å€¼
                        if (i > 0) {
                            // å¦‚æœå½“å‰é˜¶æ®µå¯ç”¨äº†æŸä¸ªæŠ¤èº«ç¬¦ï¼Œä½†ä¸Šä¸€ä¸ªé˜¶æ®µæ²¡æœ‰å¯ç”¨ï¼Œåˆ™å°†è¯¥æŠ¤èº«ç¬¦çš„å€¼è®¾ä¸º1
                            if (stage.dy_enabled && !stages[i - 1].dy_enabled) {
                                dy = new Decimal(1);
                                talismanEnabled.dy_first = true;
                                allOutputLines.push(`<span class="highlight">ç›—å°æŠ¤èº«ç¬¦ä»æœ¬é˜¶æ®µå¼€å§‹å¯ç”¨ï¼Œåˆå§‹å€¼è®¾ä¸º1</span>`);
                            }
                            if (stage.fz_enabled && !stages[i - 1].fz_enabled) {
                                fz = new Decimal(1);
                                talismanEnabled.fz_first = true;
                                allOutputLines.push(`<span class="highlight">è´Ÿé‡æŠ¤èº«ç¬¦ä»æœ¬é˜¶æ®µå¼€å§‹å¯ç”¨ï¼Œåˆå§‹å€¼è®¾ä¸º1</span>`);
                            }
                            if (stage.yg_enabled && !stages[i - 1].yg_enabled) {
                                yg = new Decimal(1);
                                talismanEnabled.yg_first = true;
                                allOutputLines.push(`<span class="highlight">æœˆå…‰æŠ¤èº«ç¬¦ä»æœ¬é˜¶æ®µå¼€å§‹å¯ç”¨ï¼Œåˆå§‹å€¼è®¾ä¸º1</span>`);
                            }
                        }

                        const result = executeCurrentStage(
                            currentLevel, stage.actualLevel, nextStageActualLevel, dy, fz, yg,
                            stage.lose_fz, stage.lose_yg, stage.eat_fog,
                            stage.dy_type, stage.fz_type, stage.yg_type,
                            stage.basicFan, stage.basicScore,
                            stage.dy_times, stage.fz_times, stage.yg_times,
                            stage.customizedParams, // ä½¿ç”¨é˜¶æ®µçš„è‡ªå®šä¹‰æŠ¤èº«ç¬¦
                            stage.name,
                            talismanEnabled
                        );

                        allOutputLines = allOutputLines.concat(result.outputLines);
                        currentLevel = result.nextLevel;
                        dy = result.dy;
                        fz = result.fz;
                        yg = result.yg;

                        // å¦‚æœå·²ç»è¾¾åˆ°æé™ï¼Œæå‰ç»“æŸ
                        if (currentLevel >= REQUIRED_SCORE.length) {
                            break;
                        }
                    }
                }

                // æ›´æ–°è¾“å‡ºæ—¥å¿—
                document.getElementById('outputLog').innerHTML = allOutputLines.map(line =>
                    `<div class="output-line">${line}</div>`).join('');

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('resultText').textContent = `EX${currentLevel - 1}`;

            } catch (error) {
                document.getElementById('outputLog').innerHTML =
                    `<div class="output-line highlight">è¾“å…¥æ ¼å¼é”™è¯¯ï¼š${error.message}</div>`;
                document.getElementById('resultText').textContent = "è®¡ç®—å¤±è´¥";
            }
        });

        // è®¾ç½®é¡¶éƒ¨å‚æ•°çš„é»˜è®¤å€¼
        document.getElementById('curLevel').value = "1";
        document.getElementById('dy').value = "144.61";
        document.getElementById('fz').value = "378.36";
        document.getElementById('yg').value = "56.02";
        document.getElementById('dy_type').value = "å¡ç»´è†¨èƒ€ç›—å°";
        document.getElementById('fz_type').value = "è†¨èƒ€è´Ÿé‡";
        document.getElementById('yg_type').value = "æ™®é€šæœˆå…‰";
        document.getElementById('basicFan').value = "19";
        document.getElementById('basicScore').value = "38";
        document.getElementById('dy_times').value = "2";
        document.getElementById('fz_times').value = "2";
        document.getElementById('yg_times').value = "1";
        document.getElementById('eat_fog').value = "0";
        document.getElementById('lose_fz').value = "0";
        document.getElementById('lose_yg').value = "0";

        // æ·»åŠ é»˜è®¤é˜¶æ®µï¼Œä½¿ç”¨é¡¶éƒ¨å‚æ•°çš„é»˜è®¤å€¼
        addStrategyStage();

        // åœ¨initå‡½æ•°ä¸­æ·»åŠ çœ¼ç›å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬
        document.getElementById('toggleMagnitudeTable').addEventListener('click', function () {
            const table = document.getElementById('magnitudeTable');
            const eye = document.getElementById('toggleMagnitudeTable');

            if (table.classList.contains('hidden')) {
                // æ˜¾ç¤ºè¡¨æ ¼
                table.classList.remove('hidden');
                eye.classList.remove('closed');
                eye.classList.add('open');
                eye.title = "ç‚¹å‡»éšè—è¡¨æ ¼";
                eye.textContent = "ğŸ‘ï¸"; // ççœ¼å›¾æ ‡
            } else {
                // éšè—è¡¨æ ¼
                table.classList.add('hidden');
                eye.classList.remove('open');
                eye.classList.add('closed');
                eye.title = "ç‚¹å‡»æ˜¾ç¤ºè¡¨æ ¼";
                eye.textContent = "ğŸ™ˆ"; // é—­çœ¼å›¾æ ‡
            }
        });

        // è®¾ç½®æŠ¤èº«ç¬¦å¼€å…³ç›‘å¬
        setupTalismanToggles();
        setupStageTalismanToggles();

        // è®¾ç½®æŠ¤èº«ç¬¦å†…å®¹çš„åˆå§‹æ˜¾ç¤ºçŠ¶æ€
        const dyEnabled = document.getElementById('dyTalismanEnabled').checked;
        const fzEnabled = document.getElementById('fzTalismanEnabled').checked;
        const ygEnabled = document.getElementById('ygTalismanEnabled').checked;

        updateTopTalismanContent('dy', dyEnabled);
        updateTopTalismanContent('fz', fzEnabled);
        updateTopTalismanContent('yg', ygEnabled);

        // åˆå§‹åŒ–å…³å¡åˆ†æ•°è¡¨æ ¼
        initScoreTable();
        setupScoreTableToggle();
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>