<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>青云之志3算极限关卡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.2/decimal.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            margin-bottom: 10px;
        }

        .description {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }

        .input-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
            border-right: 1px solid #eee;
        }

        .output-section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #444;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
        }

        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .result {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            border-left: 4px solid #2575fc;
        }

        .result h3 {
            color: #2575fc;
            margin-bottom: 10px;
        }

        .output-log {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            margin-top: 20px;
        }

        .output-line {
            margin-bottom: 5px;
        }

        .highlight {
            color: #f39c12;
            font-weight: bold;
        }

        /* 表格样式 */
        .magnitude-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .magnitude-table th {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: bold;
        }

        .magnitude-table td {
            padding: 10px 15px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .magnitude-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .magnitude-table tr:hover {
            background-color: #e9ecef;
        }

        .table-container {
            margin-top: 20px;
        }

        .table-title {
            font-size: 18px;
            color: #2575fc;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .format-examples {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* 护身符卡片样式 */
        .talisman-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .talisman-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .talisman-title {
            font-weight: bold;
            color: #2575fc;
            font-size: 18px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: #2575fc;
        }

        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }

        .talisman-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .talisman-form-group {
            margin-bottom: 10px;
        }

        .talisman-form-group label {
            font-size: 14px;
            margin-bottom: 3px;
            color: #666;
        }

        .talisman-form-group input,
        .talisman-form-group select {
            padding: 8px 10px;
            font-size: 14px;
        }

        /* 自定义护身符样式 */
        .custom-param-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .custom-param-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .custom-param-name {
            flex: 1;
            margin-right: 10px;
        }

        .remove-custom-param {
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .custom-param-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .custom-param-inputs label {
            margin-bottom: 0;
            white-space: nowrap;
        }

        .custom-param-inputs input {
            width: auto;
            flex: 1;
        }

        #addCustomParam {
            background: #27ae60;
            margin-top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-icon {
            font-size: 18px;
            font-weight: bold;
        }

        /* 自定义策略样式 */
        .strategy-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .strategy-controls {
            display: flex;
            gap: 10px;
        }

        .strategy-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .strategy-stage {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .stage-title {
            font-weight: bold;
            color: #2575fc;
            font-size: 16px;
        }

        .remove-stage {
            background: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .stage-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .stage-form-group {
            margin-bottom: 8px;
        }

        .stage-form-group label {
            font-size: 12px;
            margin-bottom: 3px;
            color: #666;
        }

        .stage-form-group input,
        .stage-form-group select {
            padding: 6px 8px;
            font-size: 14px;
        }

        .strategy-presets {
            margin-top: 15px;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* 实际开始关卡输入框样式 */
        .actual-level-input {
            width: 80px;
            margin-left: 10px;
        }

        /* 提示信息样式 */
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: #fff;
            color: #2575fc;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            transition: all 0.3s;
            box-shadow: 0 0 0 1px #2575fc;
        }

        .tooltip-icon:hover {
            background-color: #2575fc;
            color: white;
        }

        .tooltip-text {
            visibility: hidden;
            width: 350px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* 新增的阶段自定义护身符样式 */
        .stage-custom-param-group {
            background-color: #f8f9fa;
            padding: 10px 12px;
            /* 增加内边距，让内部元素不拥挤 */
            border-radius: 4px;
            margin-bottom: 8px;
            /* 每个容器之间留间距 */
            border: 1px solid #e0e0e0;
            display: flex;
            /* 用 flex 布局确保元素横向排列 */
            align-items: center;
            /* 垂直居中内部元素 */
            width: 100%;
            /* 占满外层容器宽度 */
            box-sizing: border-box;
            /* 确保 padding 不影响宽度 */
            gap: 12px;
            /* 增加内部元素间距，避免挤压 */
            flex-wrap: nowrap;
            /* PC端强制不换行，确保一行显示完整 */
        }


        .stage-custom-param-inputs {
            display: flex;
            align-items: center;
            gap: 12px;
            /* 输入框之间留足间距 */
            flex: 1;
            /* 占据容器剩余所有空间，确保能包裹输入框 */
            flex-wrap: nowrap;
            /* 强制不换行 */
        }

        .stage-custom-param-inputs input {
            padding: 6px 8px;
            font-size: 14px;
            box-sizing: border-box;
            flex-shrink: 0;
            /* 防止输入框被压缩 */
        }

        .stage-custom-param-inputs .stage-custom-param-name {
            width: 140px;
            /* 名称输入框固定宽度，足够显示“自定义护身符X” */
            min-width: 140px;
            /* PC端不允许缩小 */
        }

        .stage-custom-param-inputs .stage-custom-param-value {
            width: 100px;
            /* 倍数输入框宽度 */
            min-width: 100px;
        }

        .stage-custom-param-inputs .stage-custom-param-times {
            width: 80px;
            /* 次数输入框宽度 */
            min-width: 80px;
        }

        .stage-custom-param-inputs label {
            margin-bottom: 0;
            white-space: nowrap;
            font-size: 12px;
            flex-shrink: 0;
        }

        /* 删除按钮样式 - 确保在最右侧 */
        .stage-remove-custom-param {
            background: #e74c3c;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            /* 防止按钮被压缩 */
            margin-left: auto;
            /* 关键：将按钮推到最右侧 */
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .custom-param-inputs {
                flex-direction: column;
                align-items: flex-start;
            }

            .custom-param-inputs input {
                width: 100%;
            }

            .stage-content {
                grid-template-columns: 1fr;
            }

            .actual-level-input {
                width: 100%;
                margin-left: 0;
                margin-top: 5px;
            }

            .stage-custom-param-inputs {
                flex-direction: column;
                align-items: flex-start;
            }

            .stage-custom-param-inputs input {
                width: 100%;
            }

            .talisman-content {
                grid-template-columns: 1fr;
            }

            .stage-custom-param-group {
                overflow-x: auto;
                /* 允许水平滚动 */
                padding: 8px;
            }

            .stage-custom-param-inputs {
                flex-wrap: nowrap;
                /* 禁止换行 */
            }

            .stage-custom-param-inputs input {
                min-width: 80px;
                /* 移动端最小宽度 */
            }

            .stage-custom-param-group {
                gap: 15px;
                /* PC端增加间距，更美观 */
            }

            .stage-custom-param-inputs {
                gap: 15px;
            }

            /* 确保基础番数/分数与护身符卡片布局协调 */
            .stage-form-group.basic-fan-group,
            .stage-form-group.basic-score-group {
                grid-column: span 1;
                /* PC端让基础番数/分数并排显示 */
                max-width: none;
                /* 取消宽度限制，避免挤压 */
            }
        }

        .stage-custom-params-container {
            margin-top: 10px;
            width: 100%;
            /* 确保容器占满父元素宽度 */
            box-sizing: border-box;
            /* 避免 padding 撑大容器 */
            padding: 4px 0;
            /* 上下留少量内边距，避免元素贴边 */
        }

        .add-stage-custom-param-btn {
            background: #27ae60;
            margin-top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 6px 10px;
            font-size: 12px;
            width: auto;
        }

        .stage-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        /* 确保基础番数和基础分数在护身符卡片之后单独成行 */
        .stage-form-group[style*="grid-column"] {
            grid-column: 1 / -1;
        }

        /* 为护身符卡片设置特定的网格列跨度 */
        .talisman-card {
            grid-column: 1 / -1;
        }

        /* 确保基础番数和基础分数在护身符卡片之后显示 */
        .stage-form-group:not(.talisman-card) {
            grid-column: span 1;
        }

        /* 在PC端，让基础番数和基础分数并排显示 */
        @media (min-width: 769px) {

            .stage-form-group.basic-fan-group,
            .stage-form-group.basic-score-group {
                grid-column: span 1;
            }

            /* 确保在护身符卡片之后的基础参数正确排列 */
            .stage-content>.stage-form-group:not(.talisman-card) {
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>青云之志3算极限关卡</h1>
        <p class="description">
            根据当前资源状态计算关卡推进极限，支持多阶段自定义策略
            <span class="tooltip-container">
						<span class="tooltip-icon">ⓘ</span>
						<span class="tooltip-text">此计算器使用门槛为知道膨胀转传导玩法！支持多阶段策略配置</span>
					</span>
        </p>
    </header>

    <div class="content">
        <div class="input-section">
            <h2>输入参数
                <span class="tooltip-container">
							<span class="tooltip-icon">ⓘ</span>
							<span class="tooltip-text">商店阶段</span>
						</span>
            </h2>

            <div class="form-group">
                <label for="curLevel">当前关卡EX</label>
                <input type="number" id="curLevel" value="1" min="1" max="163">
            </div>

            <!-- 盗印护身符卡片 -->
            <div class="talisman-card" id="dyTalismanCard">
                <div class="talisman-header">
                    <div class="talisman-title">护身符 - 盗印</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dyTalismanEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="talisman-content">
                    <div class="talisman-form-group">
                        <label for="dy">
                            盗印番数
                            <span class="tooltip-container">
										<span class="tooltip-icon">ⓘ</span>
										<span class="tooltip-text">支持格式：数字(396.87)、科学计数法(3.9687e34)、单位(396.87沟)</span>
									</span>
                        </label>
                        <input type="text" id="dy" value="144.61">
                    </div>
                    <div class="talisman-form-group">
                        <label for="dy_type">盗印类型</label>
                        <select id="dy_type">
                            <option value="卡维膨胀盗印">卡维膨胀盗印</option>
                            <option value="其他卡膨胀盗印">其他卡膨胀盗印</option>
                            <option value="普通盗印">普通盗印</option>
                        </select>
                    </div>
                    <div class="talisman-form-group">
                        <label for="dy_times">盗印次数</label>
                        <input type="number" id="dy_times" value="2" min="0">
                    </div>
                    <div class="talisman-form-group">
                        <label for="eat_fog">吃迷雾次数</label>
                        <input type="number" id="eat_fog" value="0" min="0">
                    </div>
                </div>
            </div>

            <!-- 负重护身符卡片 -->
            <div class="talisman-card" id="fzTalismanCard">
                <div class="talisman-header">
                    <div class="talisman-title">护身符 - 负重</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="fzTalismanEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="talisman-content">
                    <div class="talisman-form-group">
                        <label for="fz">负重番数</label>
                        <input type="text" id="fz" value="378.36">
                    </div>
                    <div class="talisman-form-group">
                        <label for="fz_type">负重类型</label>
                        <select id="fz_type">
                            <option value="膨胀负重">膨胀负重</option>
                            <option value="天使负重">天使负重</option>
                            <option value="普通负重">普通负重</option>
                        </select>
                    </div>
                    <div class="talisman-form-group">
                        <label for="fz_times">负重次数</label>
                        <input type="number" id="fz_times" value="2" min="0">
                    </div>
                    <div class="talisman-form-group">
                        <label for="lose_fz">亏负重次数</label>
                        <input type="number" id="lose_fz" value="0" min="0">
                    </div>
                </div>
            </div>

            <!-- 月光护身符卡片 -->
            <div class="talisman-card" id="ygTalismanCard">
                <div class="talisman-header">
                    <div class="talisman-title">护身符 - 月光</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="ygTalismanEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="talisman-content">
                    <div class="talisman-form-group">
                        <label for="yg">月光番数</label>
                        <input type="text" id="yg" value="56.02">
                    </div>
                    <div class="talisman-form-group">
                        <label for="yg_type">月光类型</label>
                        <select id="yg_type">
                            <option value="普通月光">普通月光</option>
                            <option value="膨胀月光">膨胀月光</option>
                            <option value="天使月光">天使月光</option>
                        </select>
                    </div>
                    <div class="talisman-form-group">
                        <label for="yg_times">月光次数</label>
                        <input type="number" id="yg_times" value="1" min="0">
                    </div>
                    <div class="talisman-form-group">
                        <label for="lose_yg">亏月光次数</label>
                        <input type="number" id="lose_yg" value="0" min="0">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="basicFan">基础番数</label>
                <input type="number" id="basicFan" value="19" min="1">
            </div>

            <div class="form-group">
                <label for="basicScore">基础分数</label>
                <input type="number" id="basicScore" value="38" min="1">
            </div>

            <button id="addCustomParam">
                <span class="add-icon">+</span> 添加自定义护身符
            </button>

            <div id="customParamsContainer">
                <!-- 自定义护身符将在这里动态添加 -->
            </div>

            <button id="calculateBtn">计算关卡极限</button>

            <!-- 自定义策略部分 -->
            <div class="strategy-section">
                <div class="strategy-header">
                    <h2>自定义策略
                        <span class="tooltip-container">
									<span class="tooltip-icon">ⓘ</span>
									<span class="tooltip-text">1.支持从任意阶段开始自定义策略<br />
										2.第一个阶段默认同步上面的参数<br />
										3.不考虑标准配置的护身符之外其他护身符的影响<br />
										4.每个阶段默认以极限关卡转下一阶段，需要自己根据实际情况填下一阶段的实际开始关卡<br />
										5.如果以改传导卡维作为开始阶段，下一个改岚星阶段的实际开始关卡需要自己填，否则认为没改出传导卡维G了
									</span>
								</span>
                    </h2>
                    <div class="strategy-controls">
                        <button class="strategy-btn" id="addStageBtn">+ 添加阶段</button>
                    </div>
                </div>

                <div id="strategyStagesContainer">
                    <!-- 策略阶段将在这里动态添加 -->
                </div>

                <div class="strategy-presets">
                    <h3>预设策略</h3>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="standard" id="twoInflationBtn">膨胀盗印膨胀负重普通月光</button>
                    </div>
                </div>
            </div>

            <button id="calculateStrategyBtn"
                    style="background: linear-gradient(135deg, #e67e22 0%, #f39c12 100%);">执行策略计算
            </button>
        </div>

        <div class="output-section">
            <h2>计算结果</h2>

            <!-- 数量级对照表 -->
            <div class="table-container">
                <div class="table-title">数量级对照表</div>
                <table class="magnitude-table">
                    <thead>
                    <tr>
                        <th>单位</th>
                        <th>数量级</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>万</td>
                        <td>4</td>
                    </tr>
                    <tr>
                        <td>亿</td>
                        <td>8</td>
                    </tr>
                    <tr>
                        <td>兆</td>
                        <td>12</td>
                    </tr>
                    <tr>
                        <td>京</td>
                        <td>16</td>
                    </tr>
                    <tr>
                        <td>垓</td>
                        <td>20</td>
                    </tr>
                    <tr>
                        <td>秭</td>
                        <td>24</td>
                    </tr>
                    <tr>
                        <td>穰</td>
                        <td>28</td>
                    </tr>
                    <tr>
                        <td>沟</td>
                        <td>32</td>
                    </tr>
                    <tr>
                        <td>涧</td>
                        <td>36</td>
                    </tr>
                    <tr>
                        <td>正</td>
                        <td>40</td>
                    </tr>
                    <tr>
                        <td>载</td>
                        <td>44</td>
                    </tr>
                    <tr>
                        <td>极</td>
                        <td>48</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="result">
                <h3>当前配置的极限是：<span id="resultText">等待计算...</span></h3>
            </div>

            <div class="output-log" id="outputLog">
                <div class="output-line">等待计算...</div>
            </div>
        </div>
    </div>
</div>

<script>
    // 定义常量
    const FZ_TYPE_PZ = "膨胀负重";
    const FZ_TYPE_TS = "天使负重";
    const FZ_TYPE_NORMAL = "普通负重";
    const YG_TYPE_PZ = "膨胀月光";
    const YG_TYPE_TS = "天使月光";
    const YG_TYPE_NORMAL = "普通月光";
    const DY_TYPE_KW_PZ = "卡维膨胀盗印";
    const DY_TYPE_OTHER_PZ = "其他卡膨胀盗印";
    const DY_TYPE_NORMAL = "普通盗印";

    // 数量级对照表
    const MAGNITUDE_MAP = {
        "万": 4,
        "亿": 8,
        "兆": 12,
        "京": 16,
        "垓": 20,
        "秭": 24,
        "穰": 28,
        "沟": 32,
        "涧": 36,
        "正": 40,
        "载": 44,
        "极": 48
    };

    // 初始化关卡要求分数
    const REQUIRED_SCORE = initRequiredScore();

    // 自定义护身符计数器
    let customParamCounter = 1;
    // 阶段计数器
    let stageCounter = 1;
    // 是否有下一个阶段
    let hasNextStage = true;

    // 初始化关卡要求分数
    function initRequiredScore() {
        const ORIGINAL_REQUIRED_SCORE =
            "1.00E+06,1.20E+07,9.08E+07,8.11E+08,8.43E+09,1.00E+11,1.35E+12,2.06E+13,3.48E+14,6.54E+15,1.36E+17,3.09E+18,7.68E+19,2.08E+21,6.64E+22,2.46E+24,1.05E+26,5.15E+27,2.82E+29,1.83E+31,1.31E+33,1.07E+35,9.72E+36,9.94E+38,1.14E+41,1.46E+43,2.08E+45,3.31E+47,5.85E+49,1.26E+52,3.00E+54,8.71E+56,2.79E+59,1.08E+62,4.63E+64,2.40E+67,1.37E+70,9.41E+72,7.15E+75,7.09E+78,9.17E+81,1.55E+85,3.40E+88,9.73E+91,3.63E+95,1.11E+99,1.11E+103,9.11E+106,9.72E+110,1.35E+115,2.81E+119,8.79E+123,4.12E+128,2.90E+134,3.06E+138,4.84E+143,1.15E+149,4.10E+154,2.19E+160,1.76E+166,2.11E+172,3.80E+178,1.03E+185,4.17E+191,2.54E+198,2.32E+205,3.18E+212,6.54E+219,2.02E+227,9.31E+234,6.46E+242,6.72E+250,1.05E+259,2.45E+267,8.60E+275,4.53E+284,3.58E+293,4.24E+302,5.7E310,5.7E318,5.7E326,5.7E334,5.7E342,5.7E350,5.7E359,5.7E368,5.7E377,5.7E386,5.7E395,5.7E405,5.7E415,5.7E425,5.7E435,5.7E455,5.7E466,5.7E477,5.7E488,5.7E499,9.999E510,9.999E522,9.999E534,9.999E546,9.999E558,9.999E571,9.999E584,9.999E597,9.999E611,9.999E625,9.999E639,9.999E654,9.999E669,9.999E684,9.999E699,9.999E715,9.999E731,9.999E748,9.999E765,9.999E783,9.999E801,9.999E820,9.999E839,9.999E859,9.999E879,9.999E900,9.999E921,9.999E943,9.999E966,9.999E990,9.999E1015,9.999E1041,9.999E1068,9.999E1096,2.9997E1126,9.999E1155,9.999E1186,9.999E1218,9.999E1251,9.999E1285,9.999E1320,9.999E1356,9.999E1393,9.999E1431,9.999E1470,9.999E1510,9.999E1551,9.999E1593,9.999E1636,9.999E1680,2.9997E1726,9.999E1771,9.999E1818,2.9997E1867,9.999E1915,9.999E1965,9.999E2016,9.999E2068,2.9997E2122,9.999E2175,9.999E2230,9.999E2286,9.999E2343,9.999E2401,9.999E2460";
        const REQUIRED_SCORE = new Array(164);
        const split = ORIGINAL_REQUIRED_SCORE.split(",");
        for (let i = 0; i < split.length; i++) {
            REQUIRED_SCORE[i] = new Decimal(split[i]);
        }
        return REQUIRED_SCORE;
    }

    // 科学计数法格式化
    function formatScientific(number) {
        if (number.isZero()) return "0.00";
        return number.toExponential(2);
    }

    // 解析数值输入，支持数字、科学计数法和单位
    function parseValue(input) {
        if (input.includes('e') || input.includes('E')) {
            return new Decimal(input);
        }

        let unit = null;
        let numericPart = input;

        for (const unitChar in MAGNITUDE_MAP) {
            if (input.includes(unitChar)) {
                unit = unitChar;
                numericPart = input.replace(unitChar, '');
                break;
            }
        }

        const value = new Decimal(numericPart);

        if (unit) {
            const magnitude = MAGNITUDE_MAP[unit];
            return value.times(Decimal.pow(10, magnitude));
        }

        return value;
    }

    // 获取数值，如果为空则返回0
    function getValueOrDefault(value, defaultValue = 0) {
        return value === '' ? defaultValue : value;
    }

    // 获取护身符启用状态
    function getTalismanEnabledStates() {
        return {
            dy: document.getElementById('dyTalismanEnabled').checked,
            fz: document.getElementById('fzTalismanEnabled').checked,
            yg: document.getElementById('ygTalismanEnabled').checked
        };
    }

    // 执行当前关卡计算
    function executeCurrentStage(curLevel, actualLevel, nextStageActualLevel, dy, fz, yg, lose_fz, lose_yg, eat_fog,
                                 dy_type, fz_type, yg_type, basicFan, basicScore, dy_times, fz_times, yg_times, customizedParams, stageName = "",
                                 talismanEnabled = {
                                     dy: true,
                                     fz: true,
                                     yg: true
                                 }
    ) {
        let toNextStage = false;
        let outputLines = [];
        let isFirstLoop = true;
        let startLevel = curLevel;

        // 如果上一个阶段结束了，没有下一个阶段，直接返回
        if (!hasNextStage) {
            return {
                nextLevel: curLevel,
                dy: dy,
                fz: fz,
                yg: yg,
                outputLines: outputLines
            };
        }

        // 如果有实际开始关卡，直接使用填写的值
        if (actualLevel !== 0) {
            curLevel = actualLevel;
            startLevel = actualLevel;
            outputLines.push(`<span class="highlight">使用实际开始关卡: EX${actualLevel}</span>`);
        }

        if (stageName) {
            outputLines.push(`<span class="highlight">=== 阶段: ${stageName} ===</span>`);
        }

        // 输出护身符启用状态
        if (talismanEnabled.dy) {
            outputLines.push(`<span class="highlight">盗印护身符已启用</span>`);
        }
        if (talismanEnabled.fz) {
            outputLines.push(`<span class="highlight">负重护身符已启用</span>`);
        }
        if (talismanEnabled.yg) {
            outputLines.push(`<span class="highlight">月光护身符已启用</span>`);
        }

        while (!toNextStage) {
            if (talismanEnabled.dy) {
                outputLines.push(`EX${curLevel}盗印：${formatScientific(dy)}`);
            }

            // 考虑亏负重 - 只在负重护身符启用时处理
            if (talismanEnabled.fz) {
                if (lose_fz <= 0) {
                    // 负重类型
                    switch (fz_type) {
                        case FZ_TYPE_NORMAL:
                            fz = fz.times(1.5);
                            break;
                        case FZ_TYPE_TS:
                            fz = fz.times(2);
                            break;
                        case FZ_TYPE_PZ:
                            fz = fz.times(1.5 * 1.5);
                            break;
                    }
                } else {
                    lose_fz--;
                }
                outputLines.push(`EX${curLevel}负重：${formatScientific(fz)}`);
            }

            // 考虑亏月光 - 只在月光护身符启用时处理
            if (talismanEnabled.yg) {
                if (lose_yg <= 0) {
                    // 月光类型
                    switch (yg_type) {
                        case YG_TYPE_NORMAL:
                            yg = yg.times(1.5);
                            break;
                        case YG_TYPE_TS:
                            yg = yg.times(2);
                            break;
                        case YG_TYPE_PZ:
                            yg = yg.times(1.5 * 1.5);
                            break;
                    }
                } else {
                    lose_yg--;
                }
                outputLines.push(`EX${curLevel}月光：${formatScientific(yg)}`);
            }

            // 计算总番数和分数
            let zhiShuFan = new Decimal(1);

            // 只在护身符启用时计算对应部分
            if (talismanEnabled.dy) {
                zhiShuFan = zhiShuFan.times(dy.pow(dy_times));
            }
            if (talismanEnabled.fz) {
                zhiShuFan = zhiShuFan.times(fz.pow(fz_times));
            }
            if (talismanEnabled.yg) {
                zhiShuFan = zhiShuFan.times(yg.pow(yg_times));
            }

            // 添加自定义护身符参数的计算
            if (customizedParams && customizedParams.length > 0) {
                customizedParams.forEach((param, index) => {
                    if (param.value && param.times) {
                        zhiShuFan = zhiShuFan.times(param.value.pow(param.times));
                    }
                });
            }

            const totalFan = zhiShuFan.times(basicFan);
            const totalScore = totalFan.times(basicScore);

            outputLines.push(`----EX${curLevel}分数：${formatScientific(totalScore)}`);

            // 检查当前关卡是否能通过,如果不能通过，就没有下一关阶段了
            if (totalScore.lt(REQUIRED_SCORE[curLevel - 1])) {
                outputLines.push(
                    `<span class="highlight">无法达到EX${curLevel}的要求分数 ${formatScientific(REQUIRED_SCORE[curLevel - 1])}</span>`
                );
                if (stageName) {
                    // 修正推进关卡数计算逻辑
                    const stagesAdvanced = curLevel - startLevel;
                    outputLines.push(`<span class="highlight">本阶段推进: ${stagesAdvanced} 关</span>`);
                }
                console.log("Setting hasNextStage to false at level EX" + curLevel);
                hasNextStage = false;
                return {
                    nextLevel: curLevel,
                    dy: dy,
                    fz: fz,
                    yg: yg,
                    outputLines: outputLines
                };
            }

            // 检查是否能进入下一关（使用模拟成长后的分数与下一关要求分数比较）
            // 模拟一次成长后的分数，但不实际应用成长
            let simulatedDy = dy;
            let simulatedFz = fz;
            let simulatedYg = yg;

            // 模拟盗印成长 - 只在盗印护身符启用时处理
            if (talismanEnabled.dy) {
                switch (dy_type) {
                    case DY_TYPE_KW_PZ:
                        simulatedDy = simulatedDy.times(Math.pow(1.3, 4));
                        break;
                    case DY_TYPE_OTHER_PZ:
                        simulatedDy = simulatedDy.times(Math.pow(1.3, 2));
                        break;
                    case DY_TYPE_NORMAL:
                        simulatedDy = simulatedDy.times(1.3);
                        break;
                }
            }

            // 模拟负重成长（不考虑亏负重）- 只在负重护身符启用时处理
            if (talismanEnabled.fz) {
                switch (fz_type) {
                    case FZ_TYPE_NORMAL:
                        simulatedFz = simulatedFz.times(1.5);
                        break;
                    case FZ_TYPE_TS:
                        simulatedFz = simulatedFz.times(2);
                        break;
                    case FZ_TYPE_PZ:
                        simulatedFz = simulatedFz.times(1.5 * 1.5);
                        break;
                }
            }

            // 模拟月光成长（不考虑亏月光）- 只在月光护身符启用时处理
            if (talismanEnabled.yg) {
                switch (yg_type) {
                    case YG_TYPE_NORMAL:
                        simulatedYg = simulatedYg.times(1.5);
                        break;
                    case YG_TYPE_TS:
                        simulatedYg = simulatedYg.times(2);
                        break;
                    case YG_TYPE_PZ:
                        simulatedYg = simulatedYg.times(1.5 * 1.5);
                        break;
                }
            }

            // 计算模拟成长后的总番数和分数
            let simulatedZhiShuFan = new Decimal(1);

            // 只在护身符启用时计算对应部分
            if (talismanEnabled.dy) {
                simulatedZhiShuFan = simulatedZhiShuFan.times(simulatedDy.pow(dy_times));
            }
            if (talismanEnabled.fz) {
                simulatedZhiShuFan = simulatedZhiShuFan.times(simulatedFz.pow(fz_times));
            }
            if (talismanEnabled.yg) {
                simulatedZhiShuFan = simulatedZhiShuFan.times(simulatedYg.pow(yg_times));
            }

            // 添加自定义护身符参数的计算
            if (customizedParams && customizedParams.length > 0) {
                customizedParams.forEach((param, index) => {
                    if (param.value && param.times) {
                        simulatedZhiShuFan = simulatedZhiShuFan.times(param.value.pow(param.times));
                    }
                });
            }

            const simulatedTotalFan = simulatedZhiShuFan.times(basicFan);
            const simulatedTotalScore = simulatedTotalFan.times(basicScore);

            // 检查是否能进入下一关（使用模拟成长后的分数与下一关要求分数比较）
            if (simulatedTotalScore.lt(REQUIRED_SCORE[curLevel])) {
                toNextStage = true;
                outputLines.push(
                    `<span class="highlight">无法达到EX${curLevel + 1}的要求分数 ${formatScientific(REQUIRED_SCORE[curLevel])}</span>`
                );
                if (stageName) {
                    // 修正推进关卡数计算逻辑，加1
                    const stagesAdvanced = curLevel - startLevel + 1;
                    outputLines.push(`<span class="highlight">本阶段推进: ${stagesAdvanced} 关</span>`);
                }
            }

            // 检查是否达到下一阶段的实际开始关卡-1（如果指定了下一阶段的实际开始关卡）
            if (nextStageActualLevel !== 0 && curLevel >= nextStageActualLevel - 1) {
                toNextStage = true;
                outputLines.push(
                    `<span class="highlight">已达到下一阶段实际开始关卡-1 (EX${nextStageActualLevel - 1})，结束当前阶段</span>`);
                if (stageName) {
                    const stagesAdvanced = curLevel - startLevel + 1;
                    outputLines.push(`<span class="highlight">本阶段推进: ${stagesAdvanced} 关</span>`);
                }
            }

            curLevel = curLevel + 1;

            // 正常盗印成长 - 只在盗印护身符启用时处理
            if (talismanEnabled.dy) {
                switch (dy_type) {
                    case DY_TYPE_KW_PZ:
                        dy = dy.times(Math.pow(1.3, 4));
                        break;
                    case DY_TYPE_OTHER_PZ:
                        dy = dy.times(Math.pow(1.3, 2));
                        break;
                    case DY_TYPE_NORMAL:
                        dy = dy.times(1.3);
                        break;
                }

                // 处理吃迷雾次数 - 只在第一次循环中处理
                if (isFirstLoop && eat_fog > 0) {
                    for (let i = 0; i < eat_fog; i++) {
                        dy = dy.times(Math.pow(1.3, 2));
                    }
                    eat_fog = 0; // 吃迷雾次数设为0
                }
            }

            isFirstLoop = false; // 第一次循环结束

            // 防止无限循环
            if (curLevel >= REQUIRED_SCORE.length) {
                toNextStage = true;
                outputLines.push(`<span class="highlight">已达到最高关卡EX${curLevel}</span>`);
            }
        }

        return {
            nextLevel: curLevel,
            dy: dy,
            fz: fz,
            yg: yg,
            outputLines: outputLines
        };
    }

    // 添加自定义护身符
    function addCustomParam() {
        const paramId = `customParam${customParamCounter}`;

        const customParamHTML = `
    <div class="custom-param-group" id="${paramId}">
        <div class="custom-param-header">
            <input type="text" class="custom-param-name" value="自定义护身符${customParamCounter}">
            <button type="button" class="remove-custom-param" onclick="removeCustomParam('${paramId}')">×</button>
        </div>
        <div class="custom-param-inputs">
            <label>乘</label>
            <input type="text" class="custom-param-value" value="1">
            <label>番</label>
            <label>次数</label>
            <input type="number" class="custom-param-times" value="1" min="0" required>
        </div>
    </div>
`;

        document.getElementById('customParamsContainer').insertAdjacentHTML('beforeend', customParamHTML);

        // 绑定输入事件，实现双向同步
        const paramElement = document.getElementById(paramId);
        const nameInput = paramElement.querySelector('.custom-param-name');
        const valueInput = paramElement.querySelector('.custom-param-value');
        const timesInput = paramElement.querySelector('.custom-param-times');

        // 监听输入变化，同步到阶段1
        [nameInput, valueInput, timesInput].forEach(input => {
            input.addEventListener('input', function() {
                syncTopCustomParamsToStage1();
            });
        });

        customParamCounter++;

        // 同步到阶段1
        syncTopCustomParamsToStage1();
    }

    // 同步顶部自定义护身符到阶段1
    function syncTopCustomParamsToStage1() {
        const stage1 = document.querySelector('.strategy-stage');
        if (!stage1) return;

        const stageCustomParamsContainer = stage1.querySelector('.stage-custom-params-container');
        if (!stageCustomParamsContainer) return;

        // 清空阶段1的自定义护身符
        stageCustomParamsContainer.innerHTML = '';

        // 获取顶部的自定义护身符
        const topCustomParams = document.querySelectorAll('.custom-param-group');

        // 重新添加所有自定义护身符到阶段1
        topCustomParams.forEach((param, index) => {
            const nameInput = param.querySelector('.custom-param-name');
            const valueInput = param.querySelector('.custom-param-inputs input[type="text"]');
            const timesInput = param.querySelector('.custom-param-inputs input[type="number"]');

            if (nameInput && valueInput && timesInput) {
                addStageCustomParamToContainer(
                    stageCustomParamsContainer,
                    nameInput.value,
                    valueInput.value,
                    timesInput.value
                );
            }
        });
    }

    // 添加阶段自定义护身符到指定容器
    function addStageCustomParamToContainer(container, name = "", value = "1", times = "1") {
        const paramId = `stageCustomParam${Date.now()}`;

        const customParamHTML = `
    <div class="stage-custom-param-group" id="${paramId}">
        <div class="stage-custom-param-inputs">
            <input type="text" class="stage-custom-param-name" value="${name}" placeholder="护身符名称">
            <label>乘</label>
            <input type="text" class="stage-custom-param-value" value="${value}">
            <label>番</label>
            <label>次数</label>
            <input type="number" class="stage-custom-param-times" value="${times}" min="0" required>
        </div>
        <button type="button" class="stage-remove-custom-param" onclick="removeStageCustomParam('${paramId}')">×</button>
    </div>
`;

        container.insertAdjacentHTML('beforeend', customParamHTML);

        // 绑定输入事件，实现双向同步
        const paramElement = document.getElementById(paramId);
        const nameInput = paramElement.querySelector('.stage-custom-param-name');
        const valueInput = paramElement.querySelector('.stage-custom-param-value');
        const timesInput = paramElement.querySelector('.stage-custom-param-times');

        // 监听输入变化，同步到顶部
        [nameInput, valueInput, timesInput].forEach(input => {
            input.addEventListener('input', function() {
                syncStage1CustomParamsToTop();
            });
        });

        return paramId;
    }

    // 添加阶段自定义护身符
    function addStageCustomParam(stageId) {
        const container = document.getElementById(`stageCustomParams-${stageId}`);
        if (!container) return;

        // 获取当前阶段的自定义护身符数量，用于命名
        const currentCount = container.querySelectorAll('.stage-custom-param-group').length + 1;
        const paramId = addStageCustomParamToContainer(
            container,
            `自定义护身符${currentCount}`,
            "1",
            "1"
        );

        // 如果是阶段1，同步到顶部
        if (stageId === 'stage1') {
            syncStage1CustomParamsToTop();
        }
    }

    // 同步阶段1自定义护身符到顶部
    function syncStage1CustomParamsToTop() {
        const stage1 = document.querySelector('.strategy-stage');
        if (!stage1) return;

        const stageCustomParamsContainer = stage1.querySelector('.stage-custom-params-container');
        if (!stageCustomParamsContainer) return;

        // 清空顶部的自定义护身符
        document.getElementById('customParamsContainer').innerHTML = '';

        // 获取阶段1的自定义护身符
        const stageCustomParams = stageCustomParamsContainer.querySelectorAll('.stage-custom-param-group');

        // 重新添加所有自定义护身符到顶部
        stageCustomParams.forEach((param, index) => {
            const nameInput = param.querySelector('.stage-custom-param-name');
            const valueInput = param.querySelector('.stage-custom-param-value');
            const timesInput = param.querySelector('.stage-custom-param-times');

            if (nameInput && valueInput && timesInput) {
                addCustomParamToTop(
                    nameInput.value,
                    valueInput.value,
                    timesInput.value
                );
            }
        });
    }

    // 添加自定义护身符到顶部
    function addCustomParamToTop(name = "", value = "1", times = "1") {
        const paramId = `customParam${customParamCounter}`;

        const customParamHTML = `
    <div class="custom-param-group" id="${paramId}">
        <div class="custom-param-header">
            <input type="text" class="custom-param-name" value="${name}">
            <button type="button" class="remove-custom-param" onclick="removeCustomParam('${paramId}')">×</button>
        </div>
        <div class="custom-param-inputs">
            <label>乘</label>
            <input type="text" class="custom-param-value" value="${value}">
            <label>番</label>
            <label>次数</label>
            <input type="number" class="custom-param-times" value="${times}" min="0" required>
        </div>
    </div>
`;

        document.getElementById('customParamsContainer').insertAdjacentHTML('beforeend', customParamHTML);

        // 绑定输入事件，实现双向同步
        const paramElement = document.getElementById(paramId);
        const nameInput = paramElement.querySelector('.custom-param-name');
        const valueInput = paramElement.querySelector('.custom-param-value');
        const timesInput = paramElement.querySelector('.custom-param-times');

        // 监听输入变化，同步到阶段1
        [nameInput, valueInput, timesInput].forEach(input => {
            input.addEventListener('input', function() {
                syncTopCustomParamsToStage1();
            });
        });

        customParamCounter++;
    }

    // 删除自定义护身符
    function removeCustomParam(paramId) {
        const element = document.getElementById(paramId);
        if (element) {
            element.remove();
            // 同步到阶段1
            syncTopCustomParamsToStage1();
        }
    }

    // 删除阶段自定义护身符
    function removeStageCustomParam(paramId) {
        const element = document.getElementById(paramId);
        if (element) {
            element.remove();
            // 如果是阶段1，同步到顶部
            const stage1 = document.querySelector('.strategy-stage');
            if (stage1 && element.closest('.strategy-stage') === stage1) {
                syncStage1CustomParamsToTop();
            }
        }
    }

    // 添加策略阶段
    function addStrategyStage(stageData = null) {
        const stageId = `stage${stageCounter}`;
        const stageNumber = stageCounter;

        // 获取顶部参数的当前值作为默认值
        const defaultDyType = document.getElementById('dy_type').value;
        const defaultFzType = document.getElementById('fz_type').value;
        const defaultYgType = document.getElementById('yg_type').value;
        const defaultBasicFan = document.getElementById('basicFan').value;
        const defaultBasicScore = document.getElementById('basicScore').value;
        const defaultDyTimes = document.getElementById('dy_times').value;
        const defaultFzTimes = document.getElementById('fz_times').value;
        const defaultYgTimes = document.getElementById('yg_times').value;
        const defaultEatFog = document.getElementById('eat_fog').value;
        const defaultLoseFz = document.getElementById('lose_fz').value;
        const defaultLoseYg = document.getElementById('lose_yg').value;
        const defaultDyEnabled = document.getElementById('dyTalismanEnabled').checked;
        const defaultFzEnabled = document.getElementById('fzTalismanEnabled').checked;
        const defaultYgEnabled = document.getElementById('ygTalismanEnabled').checked;

        const stageHTML = `
        <div class="strategy-stage" id="${stageId}">
            <div class="stage-header">
                <div class="stage-title">阶段 ${stageNumber}</div>
                <button type="button" class="remove-stage" onclick="removeStage('${stageId}')">×</button>
            </div>
            <div class="stage-content">
                <div class="stage-form-group">
                    <label>阶段名称</label>
                    <input type="text" class="stage-name" value="${stageData?.name || `阶段${stageNumber}`}" placeholder="阶段名称">
                </div>
                <div class="stage-form-group">
                    <label>实际开始关卡</label>
                    <input type="number" class="actual-level actual-level-input" value="${stageData?.actualLevel || ''}" placeholder="不填则使用前一阶段极限" min="1" max="163">
                </div>

                <!-- 盗印护身符卡片 -->
                <div class="talisman-card">
                    <div class="talisman-header">
                        <div class="talisman-title">护身符 - 盗印</div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="stage-dy-enabled" ${(stageData?.dy_enabled !== undefined ? stageData.dy_enabled : defaultDyEnabled) ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="talisman-content">
                        <div class="stage-form-group">
                            <label>盗印类型</label>
                            <select class="dy-type">
                                <option value="普通盗印" ${(stageData?.dy_type || defaultDyType) === '普通盗印' ? 'selected' : ''}>普通盗印</option>
                                <option value="卡维膨胀盗印" ${(stageData?.dy_type || defaultDyType) === '卡维膨胀盗印' ? 'selected' : ''}>卡维膨胀盗印</option>
                                <option value="其他卡膨胀盗印" ${(stageData?.dy_type || defaultDyType) === '其他卡膨胀盗印' ? 'selected' : ''}>其他卡膨胀盗印</option>
                            </select>
                        </div>
                        <div class="stage-form-group">
                            <label>盗印次数</label>
                            <input type="number" class="dy-times" value="${stageData?.dy_times || defaultDyTimes}" min="0">
                        </div>
                        <div class="stage-form-group">
                            <label>吃迷雾次数</label>
                            <input type="number" class="eat-fog" value="${stageData?.eat_fog ?? defaultEatFog}" min="0">
                        </div>
                    </div>
                </div>

                <!-- 负重护身符卡片 -->
                <div class="talisman-card">
                    <div class="talisman-header">
                        <div class="talisman-title">护身符 - 负重</div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="stage-fz-enabled" ${(stageData?.fz_enabled !== undefined ? stageData.fz_enabled : defaultFzEnabled) ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="talisman-content">
                        <div class="stage-form-group">
                            <label>负重类型</label>
                            <select class="fz-type">
                                <option value="膨胀负重" ${(stageData?.fz_type || defaultFzType) === '膨胀负重' ? 'selected' : ''}>膨胀负重</option>
                                <option value="天使负重" ${(stageData?.fz_type || defaultFzType) === '天使负重' ? 'selected' : ''}>天使负重</option>
                                <option value="普通负重" ${(stageData?.fz_type || defaultFzType) === '普通负重' ? 'selected' : ''}>普通负重</option>
                            </select>
                        </div>
                        <div class="stage-form-group">
                            <label>负重次数</label>
                            <input type="number" class="fz-times" value="${stageData?.fz_times || defaultFzTimes}" min="0">
                        </div>
                        <div class="stage-form-group">
                            <label>亏负重次数</label>
                            <input type="number" class="lose-fz" value="${stageData?.lose_fz ?? defaultLoseFz}" min="0">
                        </div>
                    </div>
                </div>

                <!-- 月光护身符卡片 -->
                <div class="talisman-card">
                    <div class="talisman-header">
                        <div class="talisman-title">护身符 - 月光</div>
                        <label class="toggle-switch">
                            <input type="checkbox" class="stage-yg-enabled" ${(stageData?.yg_enabled !== undefined ? stageData.yg_enabled : defaultYgEnabled) ? 'checked' : ''}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="talisman-content">
                        <div class="stage-form-group">
                            <label>月光类型</label>
                            <select class="yg-type">
                                <option value="普通月光" ${(stageData?.yg_type || defaultYgType) === '普通月光' ? 'selected' : ''}>普通月光</option>
                                <option value="膨胀月光" ${(stageData?.yg_type || defaultYgType) === '膨胀月光' ? 'selected' : ''}>膨胀月光</option>
                                <option value="天使月光" ${(stageData?.yg_type || defaultYgType) === '天使月光' ? 'selected' : ''}>天使月光</option>
                            </select>
                        </div>
                        <div class="stage-form-group">
                            <label>月光次数</label>
                            <input type="number" class="yg-times" value="${stageData?.yg_times || defaultYgTimes}" min="0">
                        </div>
                        <div class="stage-form-group">
                            <label>亏月光次数</label>
                            <input type="number" class="lose-yg" value="${stageData?.lose_yg ?? defaultLoseYg}" min="0">
                        </div>
                    </div>
                </div>

                <div class="stage-form-group basic-fan-group">
                    <label>基础番数</label>
                    <input type="number" class="basic-fan" value="${stageData?.basicFan || defaultBasicFan}" min="1">
                </div>
                <div class="stage-form-group basic-score-group">
                    <label>基础分数</label>
                    <input type="number" class="basic-score" value="${stageData?.basicScore || defaultBasicScore}" min="1">
                </div>
                <div class="stage-form-group" style="grid-column: 1 / -1;">
                    <button type="button" class="add-stage-custom-param-btn strategy-btn" onclick="addStageCustomParam('${stageId}')">
                        <span class="add-icon">+</span> 添加自定义护身符
                    </button>
                    <div class="stage-custom-params-container" id="stageCustomParams-${stageId}">
                        <!-- 阶段自定义护身符将在这里动态添加 -->
                    </div>
                </div>
            </div>
        </div>
    `;

        document.getElementById('strategyStagesContainer').insertAdjacentHTML('beforeend', stageHTML);

        // 如果是第一个阶段，设置双向绑定
        if (stageNumber === 1) {
            setupStage1Binding(stageId);

            // 同步顶部的自定义护身符到阶段1
            syncTopCustomParamsToStage1();
        }

        stageCounter++;
    }

    // 设置阶段1与顶部参数的双向绑定
    function setupStage1Binding(stageId) {
        const stageElement = document.getElementById(stageId);

        // 获取阶段1的元素
        const stageDyType = stageElement.querySelector('.dy-type');
        const stageFzType = stageElement.querySelector('.fz-type');
        const stageYgType = stageElement.querySelector('.yg-type');
        const stageBasicFan = stageElement.querySelector('.basic-fan');
        const stageBasicScore = stageElement.querySelector('.basic-score');
        const stageDyTimes = stageElement.querySelector('.dy-times');
        const stageFzTimes = stageElement.querySelector('.fz-times');
        const stageYgTimes = stageElement.querySelector('.yg-times');
        const stageEatFog = stageElement.querySelector('.eat-fog');
        const stageLoseFz = stageElement.querySelector('.lose-fz');
        const stageLoseYg = stageElement.querySelector('.lose-yg');
        const stageDyEnabled = stageElement.querySelector('.stage-dy-enabled');
        const stageFzEnabled = stageElement.querySelector('.stage-fz-enabled');
        const stageYgEnabled = stageElement.querySelector('.stage-yg-enabled');

        // 阶段1 -> 顶部参数
        stageDyType.addEventListener('change', () => document.getElementById('dy_type').value = stageDyType.value);
        stageFzType.addEventListener('change', () => document.getElementById('fz_type').value = stageFzType.value);
        stageYgType.addEventListener('change', () => document.getElementById('yg_type').value = stageYgType.value);
        stageBasicFan.addEventListener('input', () => document.getElementById('basicFan').value = stageBasicFan.value);
        stageBasicScore.addEventListener('input', () => document.getElementById('basicScore').value = stageBasicScore
            .value);
        stageDyTimes.addEventListener('input', () => document.getElementById('dy_times').value = stageDyTimes.value);
        stageFzTimes.addEventListener('input', () => document.getElementById('fz_times').value = stageFzTimes.value);
        stageYgTimes.addEventListener('input', () => document.getElementById('yg_times').value = stageYgTimes.value);
        stageEatFog.addEventListener('input', () => document.getElementById('eat_fog').value = stageEatFog.value);
        stageLoseFz.addEventListener('input', () => document.getElementById('lose_fz').value = stageLoseFz.value);
        stageLoseYg.addEventListener('input', () => document.getElementById('lose_yg').value = stageLoseYg.value);
        stageDyEnabled.addEventListener('change', () => document.getElementById('dyTalismanEnabled').checked =
            stageDyEnabled.checked);
        stageFzEnabled.addEventListener('change', () => document.getElementById('fzTalismanEnabled').checked =
            stageFzEnabled.checked);
        stageYgEnabled.addEventListener('change', () => document.getElementById('ygTalismanEnabled').checked =
            stageYgEnabled.checked);

        // 顶部参数 -> 阶段1
        document.getElementById('dy_type').addEventListener('change', () => stageDyType.value = document.getElementById(
            'dy_type').value);
        document.getElementById('fz_type').addEventListener('change', () => stageFzType.value = document.getElementById(
            'fz_type').value);
        document.getElementById('yg_type').addEventListener('change', () => stageYgType.value = document.getElementById(
            'yg_type').value);
        document.getElementById('basicFan').addEventListener('input', () => stageBasicFan.value = document
            .getElementById('basicFan').value);
        document.getElementById('basicScore').addEventListener('input', () => stageBasicScore.value = document
            .getElementById('basicScore').value);
        document.getElementById('dy_times').addEventListener('input', () => stageDyTimes.value = document.getElementById(
            'dy_times').value);
        document.getElementById('fz_times').addEventListener('input', () => stageFzTimes.value = document.getElementById(
            'fz_times').value);
        document.getElementById('yg_times').addEventListener('input', () => stageYgTimes.value = document.getElementById(
            'yg_times').value);
        document.getElementById('eat_fog').addEventListener('input', () => stageEatFog.value = document.getElementById(
            'eat_fog').value);
        document.getElementById('lose_fz').addEventListener('input', () => stageLoseFz.value = document.getElementById(
            'lose_fz').value);
        document.getElementById('lose_yg').addEventListener('input', () => stageLoseYg.value = document.getElementById(
            'lose_yg').value);
        document.getElementById('dyTalismanEnabled').addEventListener('change', () => stageDyEnabled.checked = document
            .getElementById('dyTalismanEnabled').checked);
        document.getElementById('fzTalismanEnabled').addEventListener('change', () => stageFzEnabled.checked = document
            .getElementById('fzTalismanEnabled').checked);
        document.getElementById('ygTalismanEnabled').addEventListener('change', () => stageYgEnabled.checked = document
            .getElementById('ygTalismanEnabled').checked);
    }

    // 删除阶段
    function removeStage(stageId) {
        const element = document.getElementById(stageId);
        if (element) {
            element.remove();
            // 重新编号所有阶段
            renumberStages();
        }
    }

    // 重新编号阶段
    function renumberStages() {
        const stages = document.querySelectorAll('.strategy-stage');
        stageCounter = 1;
        stages.forEach((stage, index) => {
            const title = stage.querySelector('.stage-title');
            const nameInput = stage.querySelector('.stage-name');
            title.textContent = `阶段 ${index + 1}`;
            if (nameInput.value === `阶段${stageCounter}` || nameInput.value.includes('阶段')) {
                nameInput.value = `阶段${index + 1}`;
            }

            // 如果是第一个阶段，重新设置双向绑定
            if (index === 0) {
                setupStage1Binding(stage.id);
            }

            stageCounter++;
        });
    }

    // 获取所有阶段配置
    function getAllStages() {
        const stages = [];
        const stageElements = document.querySelectorAll('.strategy-stage');

        stageElements.forEach((stageElement) => {
            const stageId = stageElement.id;
            const customizedParams = getStageCustomizedParams(stageId);

            const stageData = {
                name: stageElement.querySelector('.stage-name').value,
                actualLevel: parseInt(stageElement.querySelector('.actual-level').value) || 0,
                dy_type: stageElement.querySelector('.dy-type').value,
                fz_type: stageElement.querySelector('.fz-type').value,
                yg_type: stageElement.querySelector('.yg-type').value,
                basicFan: parseInt(stageElement.querySelector('.basic-fan').value),
                basicScore: parseInt(stageElement.querySelector('.basic-score').value),
                dy_times: parseInt(stageElement.querySelector('.dy-times').value),
                fz_times: parseInt(stageElement.querySelector('.fz-times').value),
                yg_times: parseInt(stageElement.querySelector('.yg-times').value),
                eat_fog: parseInt(getValueOrDefault(stageElement.querySelector('.eat-fog').value, 0)),
                lose_fz: parseInt(getValueOrDefault(stageElement.querySelector('.lose-fz').value, 0)),
                lose_yg: parseInt(getValueOrDefault(stageElement.querySelector('.lose-yg').value, 0)),
                dy_enabled: stageElement.querySelector('.stage-dy-enabled').checked,
                fz_enabled: stageElement.querySelector('.stage-fz-enabled').checked,
                yg_enabled: stageElement.querySelector('.stage-yg-enabled').checked,
                customizedParams: customizedParams
            };

            stages.push(stageData);
        });

        return stages;
    }

    // 获取阶段自定义护身符参数
    function getStageCustomizedParams(stageId) {
        const container = document.getElementById(`stageCustomParams-${stageId}`);
        if (!container) return [];

        const customParams = [];
        const customParamGroups = container.querySelectorAll('.stage-custom-param-group');

        customParamGroups.forEach((group, index) => {
            const timesInput = group.querySelector('.stage-custom-param-times');
            const valueInput = group.querySelector('.stage-custom-param-value');

            if (valueInput && timesInput) {
                try {
                    const value = parseValue(valueInput.value);
                    const times = parseInt(timesInput.value) || 0;

                    if (value && !isNaN(times)) {
                        customParams.push({
                            value: value,
                            times: times
                        });
                    }
                } catch (error) {
                    console.error('解析阶段自定义参数错误:', error);
                }
            }
        });

        return customParams;
    }

    // 获取所有自定义护身符参数
    function getCustomizedParams() {
        const customParams = [];
        const customParamGroups = document.querySelectorAll('.custom-param-group');

        customParamGroups.forEach((group, index) => {
            const timesInput = group.querySelector('.custom-param-times');
            const valueInput = group.querySelector('.custom-param-value');
            const nameInput = group.querySelector('.custom-param-name');

            if (valueInput && timesInput && nameInput) {
                try {
                    const value = parseValue(valueInput.value);
                    const times = parseInt(timesInput.value) || 0;
                    const name = nameInput.value;

                    if (value && !isNaN(times)) {
                        customParams.push({
                            name: name,
                            value: value,
                            times: times
                        });
                    }
                } catch (error) {
                    console.error('解析自定义参数错误:', error);
                }
            }
        });

        return customParams;
    }

    // 膨胀盗印膨胀负重普通月光策略配置
    const twoInflationStrategy = [{
        name: "改传导卡维",
        actualLevel: 0,
        dy_type: "卡维膨胀盗印",
        fz_type: "膨胀负重",
        yg_type: "普通月光",
        basicFan: 19,
        basicScore: 38,
        dy_times: 2,
        fz_times: 2,
        yg_times: 1,
        eat_fog: 0,
        lose_fz: 0,
        lose_yg: 0,
        dy_enabled: true,
        fz_enabled: true,
        yg_enabled: true
    },
        {
            name: "改岚星",
            actualLevel: 0,
            dy_type: "其他卡膨胀盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 38,
            dy_times: 2,
            fz_times: 2,
            yg_times: 1,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "岚星入链",
            actualLevel: 0,
            dy_type: "其他卡膨胀盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 38,
            dy_times: 3,
            fz_times: 2,
            yg_times: 1,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "月光入链",
            actualLevel: 0,
            dy_type: "其他卡膨胀盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 38,
            dy_times: 3,
            fz_times: 2,
            yg_times: 3,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "盗印入链",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 4,
            fz_times: 2,
            yg_times: 3,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩入链",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 5,
            fz_times: 2,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩移到盗印前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 2,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩移到月光前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "膨胀负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 2,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "负重入链",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 5,
            fz_times: 6,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩移到负重前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 5,
            fz_times: 7,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩移到盗印前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 7,
            yg_times: 4,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩移到月光前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 7,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "八链成型",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 6,
            fz_times: 8,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "天恩移到盗印前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 7,
            fz_times: 8,
            yg_times: 5,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        },
        {
            name: "最终阶段：天恩移到月光前面",
            actualLevel: 0,
            dy_type: "普通盗印",
            fz_type: "普通负重",
            yg_type: "普通月光",
            basicFan: 23,
            basicScore: 100000,
            dy_times: 7,
            fz_times: 8,
            yg_times: 6,
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0,
            dy_enabled: true,
            fz_enabled: true,
            yg_enabled: true
        }
    ];

    // 应用膨胀盗印膨胀负重普通月光策略
    function applyTwoInflationStrategy() {
        // 清除所有现有阶段
        document.getElementById('strategyStagesContainer').innerHTML = '';
        stageCounter = 1;

        // 添加新阶段
        twoInflationStrategy.forEach(stageData => {
            addStrategyStage(stageData);
        });

        // 显示提示信息
        alert("此为膨胀盗印+膨胀负重+普通月光的标准策略；\n阶段2的实际开始关卡就是改出传导卡维的那关，如果为空，则表示没改出传导卡维，就不会执行后续阶段了；\n吸星按照1万星币来算");
    }

    // 初始化函数
    function init() {
        // 事件监听
        document.getElementById('addCustomParam').addEventListener('click', addCustomParam);
        document.getElementById('addStageBtn').addEventListener('click', () => addStrategyStage({
            eat_fog: 0,
            lose_fz: 0,
            lose_yg: 0
        }));
        document.getElementById('twoInflationBtn').addEventListener('click', applyTwoInflationStrategy);

        // 单次计算按钮点击事件
        document.getElementById('calculateBtn').addEventListener('click', function() {
            try {
                // 获取输入值，如果为空则默认为0
                const curLevel = parseInt(document.getElementById('curLevel').value);
                const dy = parseValue(document.getElementById('dy').value);
                const fz = parseValue(document.getElementById('fz').value);
                const yg = parseValue(document.getElementById('yg').value);
                const eat_fog = parseInt(getValueOrDefault(document.getElementById('eat_fog').value, 0));
                const lose_fz = parseInt(getValueOrDefault(document.getElementById('lose_fz').value, 0));
                const lose_yg = parseInt(getValueOrDefault(document.getElementById('lose_yg').value, 0));
                const dy_type = document.getElementById('dy_type').value;
                const fz_type = document.getElementById('fz_type').value;
                const yg_type = document.getElementById('yg_type').value;
                const basicFan = parseInt(document.getElementById('basicFan').value);
                const basicScore = parseInt(document.getElementById('basicScore').value);
                const dy_times = parseInt(document.getElementById('dy_times').value);
                const fz_times = parseInt(document.getElementById('fz_times').value);
                const yg_times = parseInt(document.getElementById('yg_times').value);

                // 获取自定义护身符参数
                const customizedParams = getCustomizedParams();

                // 获取护身符启用状态
                const talismanEnabled = getTalismanEnabledStates();

                // 执行计算
                const result = executeCurrentStage(
                    curLevel, 0, 0, dy, fz, yg,
                    lose_fz, lose_yg, eat_fog,
                    dy_type, fz_type, yg_type,
                    basicFan, basicScore,
                    dy_times, fz_times, yg_times,
                    customizedParams,
                    "当前",
                    talismanEnabled
                );

                // 更新输出日志
                document.getElementById('outputLog').innerHTML = result.outputLines.map(line =>
                    `<div class="output-line">${line}</div>`).join(
                    '');

                // 显示结果
                document.getElementById('resultText').textContent = `EX${result.nextLevel - 1}`;
            } catch (error) {
                document.getElementById('outputLog').innerHTML =
                    `<div class="output-line highlight">输入格式错误：${error.message}</div>`;
                document.getElementById('resultText').textContent = "计算失败";
            }
        });

        // 策略计算按钮点击事件
        document.getElementById('calculateStrategyBtn').addEventListener('click', function() {
            try {
                // 重置 hasNextStage
                hasNextStage = true;
                // 获取初始参数
                const curLevel = parseInt(document.getElementById('curLevel').value);
                let dy = parseValue(document.getElementById('dy').value);
                let fz = parseValue(document.getElementById('fz').value);
                let yg = parseValue(document.getElementById('yg').value);

                // 获取所有阶段配置
                const stages = getAllStages();

                let currentLevel = curLevel;
                let allOutputLines = [];

                // 如果没有阶段，使用默认单阶段计算
                if (stages.length === 0) {
                    allOutputLines.push(`<span class="highlight">未配置策略阶段，使用默认计算</span>`);
                    const talismanEnabled = getTalismanEnabledStates();
                    const result = executeCurrentStage(
                        currentLevel, 0, 0, dy, fz, yg,
                        0, 0, 0,
                        "普通盗印", "膨胀负重", "普通月光",
                        23, 1111100,
                        6, 3, 5,
                        [],
                        "默认阶段",
                        talismanEnabled
                    );

                    allOutputLines = allOutputLines.concat(result.outputLines);
                    currentLevel = result.nextLevel;
                    dy = result.dy;
                    fz = result.fz;
                    yg = result.yg;
                } else {
                    // 按顺序执行每个阶段
                    for (let i = 0; i < stages.length; i++) {
                        const stage = stages[i];

                        // 获取下一阶段的实际开始关卡（如果有的话）
                        const nextStageActualLevel = i + 1 < stages.length ? stages[i + 1].actualLevel : 0;

                        const talismanEnabled = {
                            dy: stage.dy_enabled,
                            fz: stage.fz_enabled,
                            yg: stage.yg_enabled
                        };

                        const result = executeCurrentStage(
                            currentLevel, stage.actualLevel, nextStageActualLevel, dy, fz, yg,
                            stage.lose_fz, stage.lose_yg, stage.eat_fog,
                            stage.dy_type, stage.fz_type, stage.yg_type,
                            stage.basicFan, stage.basicScore,
                            stage.dy_times, stage.fz_times, stage.yg_times,
                            stage.customizedParams, // 使用阶段的自定义护身符
                            stage.name,
                            talismanEnabled
                        );

                        allOutputLines = allOutputLines.concat(result.outputLines);
                        currentLevel = result.nextLevel;
                        dy = result.dy;
                        fz = result.fz;
                        yg = result.yg;

                        // 如果已经达到极限，提前结束
                        if (currentLevel >= REQUIRED_SCORE.length) {
                            break;
                        }
                    }
                }

                // 更新输出日志
                document.getElementById('outputLog').innerHTML = allOutputLines.map(line =>
                    `<div class="output-line">${line}</div>`).join('');

                // 显示结果
                document.getElementById('resultText').textContent = `EX${currentLevel - 1}`;

            } catch (error) {
                document.getElementById('outputLog').innerHTML =
                    `<div class="output-line highlight">输入格式错误：${error.message}</div>`;
                document.getElementById('resultText').textContent = "计算失败";
            }
        });

        // 设置顶部参数的默认值
        document.getElementById('curLevel').value = "1";
        document.getElementById('dy').value = "144.61";
        document.getElementById('fz').value = "378.36";
        document.getElementById('yg').value = "56.02";
        document.getElementById('dy_type').value = "卡维膨胀盗印";
        document.getElementById('fz_type').value = "膨胀负重";
        document.getElementById('yg_type').value = "普通月光";
        document.getElementById('basicFan').value = "19";
        document.getElementById('basicScore').value = "38";
        document.getElementById('dy_times').value = "2";
        document.getElementById('fz_times').value = "2";
        document.getElementById('yg_times').value = "1";
        document.getElementById('eat_fog').value = "0";
        document.getElementById('lose_fz').value = "0";
        document.getElementById('lose_yg').value = "0";

        // 添加默认阶段，使用顶部参数的默认值
        addStrategyStage();
    }

    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>